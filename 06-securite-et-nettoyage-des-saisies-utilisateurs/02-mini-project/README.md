# Cours 06 - SÃ©curitÃ© et nettoyage des saisies utilisateurs - Mini-projet

Ce mini-projet est conÃ§u pour vous permettre de mettre en pratique les concepts
thÃ©oriques vus dans le cours
_[Cours 06 - SÃ©curitÃ© et nettoyage des saisies utilisateurs](../01-theorie/README.md)_.

## Ressources

- ThÃ©orie : [Support de cours](../01-theorie/README.md) Â·
  [PrÃ©sentation (web)](https://heig-vd-progserv1-course.github.io/heig-vd-progserv1-course/06-securite-et-nettoyage-des-saisies-utilisateurs/01-theorie/index.html)
  Â·
  [PrÃ©sentation (PDF)](https://heig-vd-progserv1-course.github.io/heig-vd-progserv1-course/06-securite-et-nettoyage-des-saisies-utilisateurs/01-theorie/06-securite-et-nettoyage-des-saisies-utilisateurs-presentation.pdf)
- Mini-projet : [Consignes](../02-mini-project/README.md) Â·
  [Solution](../02-mini-project/solution/)
- Exercices : [Ã‰noncÃ©s et solutions](../03-exercices/README.md)

## Table des matiÃ¨res

- [Ressources](#ressources)
- [Table des matiÃ¨res](#table-des-matiÃ¨res)
- [Objectifs de la session](#objectifs-de-la-session)
- [Sauvegarder une copie de la base donnÃ©es](#sauvegarder-une-copie-de-la-base-donnÃ©es)
- [RÃ©aliser une injection SQL](#rÃ©aliser-une-injection-sql)
  - [Ã‰tape 1 : identifier une vulnÃ©rabilitÃ©](#Ã©tape-1--identifier-une-vulnÃ©rabilitÃ©)
  - [Ã‰tape 2 : former la requÃªte SQL](#Ã©tape-2--former-la-requÃªte-sql)
  - [Ã‰tape 3 : rÃ©aliser l'injection SQL](#Ã©tape-3--rÃ©aliser-linjection-sql)
  - [Ã‰tape 4 : corriger la vulnÃ©rabilitÃ©](#Ã©tape-4--corriger-la-vulnÃ©rabilitÃ©)
  - [Ã‰tape 5 : tester l'application](#Ã©tape-5--tester-lapplication)
- [RÃ©aliser une attaque XSS](#rÃ©aliser-une-attaque-xss)
  - [Ã‰tape 1 : identifier une vulnÃ©rabilitÃ©](#Ã©tape-1--identifier-une-vulnÃ©rabilitÃ©-1)
  - [Ã‰tape 2 : rÃ©aliser l'attaque XSS](#Ã©tape-2--rÃ©aliser-lattaque-xss)
  - [Ã‰tape 3 : corriger la vulnÃ©rabilitÃ©](#Ã©tape-3--corriger-la-vulnÃ©rabilitÃ©)
  - [Ã‰tape 4 : tester l'application](#Ã©tape-4--tester-lapplication)
- [Ajout de la possibilitÃ© de mettre Ã  jour un animal](#ajout-de-la-possibilitÃ©-de-mettre-Ã -jour-un-animal)
  - [Ajout du fichier `edit.php`](#ajout-du-fichier-editphp)
  - [Mise Ã  jour de la fonction `updatePet()`](#mise-Ã -jour-de-la-fonction-updatepet)
  - [Mise Ã  jour du fichier `view.php`](#mise-Ã -jour-du-fichier-viewphp)
  - [Mise Ã  jour du fichier `index.php`](#mise-Ã -jour-du-fichier-indexphp)
  - [Tests de l'application](#tests-de-lapplication)
- [Solution](#solution)
- [Conclusion](#conclusion)
- [Aller plus loin](#aller-plus-loin)

## Objectifs de la session

Vous avez maintenant une petite application PHP fonctionnelle qui vous permet de
stocker et de gÃ©rer des animaux de compagnie.

Cependant, cette application n'est pas sÃ©curisÃ©e et prÃ©sente plusieurs
vulnÃ©rabilitÃ©s qui la rendent facilement attaquable. Cela met en danger les
donnÃ©es de l'application et la sÃ©curitÃ© des utilisateurs.

L'objectif de cette session est de vous familiariser avec les attaques les plus
courantes sur le web et de vous montrer comment les rÃ©aliser sur une application
PHP et, surtout, comment les corriger.

Ã€ l'issue de cette session, les personnes qui Ã©tudient devraient avoir pu :

- RÃ©aliser une injection SQL sur une application PHP
- RÃ©aliser une attaque XSS sur une application PHP
- Corriger les vulnÃ©rabilitÃ©s de l'application PHP

## Sauvegarder une copie de la base donnÃ©es

Avant de commencer, il est recommandÃ© de sauvegarder la base de donnÃ©es de
l'application PHP que vous avez dÃ©veloppÃ©e dans le mini-projet prÃ©cÃ©dent. Cela
vous permettra de revenir Ã  une version fonctionnelle de l'application car
celle-ci sera modifiÃ©e lors de la rÃ©alisation des attaques.

Pour sauvegarder la base de donnÃ©es, copiez simplement le fichier
`petsmanager.db` sous un autre nom, par exemple `petsmanager_backup.db`.

Conservez cette copie et restaurez-la autant que nÃ©cessaire pour revenir Ã  une
version fonctionnelle de l'application si besoin.

Pour restaurer la base de donnÃ©es, il suffit supprimer la base de donnÃ©es
existante (`petsmanager.db`) puis de copier le fichier `petsmanager_backup.db`
et de le renommer en `petsmanager.db`.

Cela restaurera la version sauvegardÃ©e.

## RÃ©aliser une injection SQL

Dans cette section, vous allez rÃ©aliser une injection SQL sur l'application PHP
que vous avez dÃ©veloppÃ©e dans le mini-projet prÃ©cÃ©dent.

Puis, vous allez corriger toutes les vulnÃ©rabilitÃ©s d'injections SQL pour
sÃ©curiser votre application.

### Ã‰tape 1 : identifier une vulnÃ©rabilitÃ©

L'application PHP que vous avez dÃ©veloppÃ©e dans le mini-projet prÃ©cÃ©dent est
vulnÃ©rable aux injections SQL. En effet, il y a plusieurs endroits dans le code
oÃ¹ des donnÃ©es non filtrÃ©es sont insÃ©rÃ©es directement dans une requÃªte SQL.

Par exemple, lorsque vous ajoutez un animal de compagnie par exemple, les
propriÃ©tÃ©s de l'animal (nom, espÃ¨ce, etc.) sont directement insÃ©rÃ©es dans la
requÃªte SQL sans aucun filtrage ni Ã©chappement :

```php
function addPet(
    $name,
    $species,
    $nickname,
    $sex,
    $age,
    $color,
    $personalities,
    $size,
    $notes
) {
    // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pdo`.
    // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
    global $pdo;

    // On transforme le tableau `$personalities` en chaÃ®ne de caractÃ¨res avec `implode`
    $personalitiesAsString = implode(',', $personalities);

    // On dÃ©finit la requÃªte SQL pour ajouter un animal
    $sql = "INSERT INTO pets (
        name,
        species,
        nickname,
        sex,
        age,
        color,
        personalities,
        size,
        notes
    ) VALUES (
        '$name',
        '$species',
        '$nickname',
        '$sex',
        $age,
        '$color',
        '$personalitiesAsString',
        $size,
        '$notes'
    )";

    // On exÃ©cute la requÃªte SQL pour ajouter un animal
    $pdo->exec($sql);

    // On rÃ©cupÃ¨re l'identifiant de l'animal ajoutÃ©
    $petId = $pdo->lastInsertId();

    // On retourne l'identifiant de l'animal ajoutÃ©.
    return $petId;
}
```

Cela signifie qu'un attaquant peut facilement injecter du code SQL malveillant
dans une ou l'autre des propriÃ©tÃ©s de l'animal.

### Ã‰tape 2 : former la requÃªte SQL

Pour rÃ©aliser l'injection SQL, vous devez d'abord former la requÃªte SQL que vous
allez injecter dans l'application.

Dans cet exemple, nous allons rÃ©aliser une injection SQL qui va supprimer la
base de donnÃ©es entiÃ¨re de l'application.

Pour cela, vous devez former la requÃªte SQL suivante par un moyen ou un autre :

```sql
DROP TABLE pets;
```

Cette requÃªte a pour but de supprimer la table `pets` de la base de donnÃ©es, ce
qui entraÃ®nera la perte de toutes les donnÃ©es de l'application.

Ã€ cette fin, vous pouvez utiliser les notes de l'animal pour injecter la requÃªte
SQL.

Nous pouvons donc dÃ©duire que le texte que nous allons entrer dans le champ
`notes` de l'application sera le suivant :

```sql
'); DROP TABLE pets; --'
```

Ce qui donnera la requÃªte SQL suivante :

```sql
INSERT INTO pets (name, species, nickname, sex, age, color, personalities, size, notes
) VALUES ('Fluffy', 'dog', 'Fluff', 'male', 3, '#ff0000', 'gentil,curious', 10, ''); DROP TABLE pets; --');
```

Cette requÃªte, construite grÃ¢ce Ã  votre injection SQL, va rÃ©aliser en rÃ©alitÃ©
deux requÃªtes SQL :

1. InsÃ©rer un animal de compagnie avec le nom `Fluffy`
2. Supprimer la table `pets` de la base de donnÃ©es.

La premiÃ¨re partie de la requÃªte est la mÃªme que celle que vous avez utilisÃ©e
pour ajouter un animal de compagnie dans l'application. La seconde partie de la
requÃªte est la requÃªte SQL que vous avez formÃ©e Ã  l'Ã©tape prÃ©cÃ©dente.

La partie `--` Ã  la fin de la requÃªte est un commentaire SQL qui peut permettre
d'ignorer le reste de la requÃªte. Cela permet d'Ã©viter les erreurs de syntaxe
dans la requÃªte SQL (ce n'est pas toujours nÃ©cessaire, cela peut Ã©viter
certaines erreurs).

### Ã‰tape 3 : rÃ©aliser l'injection SQL

Maintenant que vous avez identifiÃ© le champ et la valeur nÃ©cessaire pour
celui-ci, vous pouvez rÃ©aliser l'injection SQL.

InsÃ©rez simplement un animal de compagnie dans l'application avec la requÃªte SQL
que vous avez formÃ©e Ã  la section prÃ©cÃ©dente :

- Nom : `Fluffy`
- EspÃ¨ce : `Chien`
- Surnom : `Fluff`
- Sexe : `MÃ¢le`
- Ã‚ge : `3`
- Couleur : `#ff0000`
- PersonnalitÃ© : `gentil,curious`
- Taille : `10`
- Notes : `'); DROP TABLE pets; --`

Il se peut qu'une erreur s'affiche lorsque vous essayez d'insÃ©rer l'animal de
compagnie. Cela n'est pas grave, l'injection SQL devrait dÃ©jÃ  avoir Ã©tÃ© rÃ©alisÃ©e
et la requÃªte SQL exÃ©cutÃ©e.

L'action d'insertion de l'animal dans la base de donnÃ©es exÃ©cutera la requÃªte
SQL que vous avez formÃ©e, ce qui devrait entraÃ®ner la suppression de la table
`pets` de la base de donnÃ©es.

AprÃ¨s avoir insÃ©rÃ© Fluffy, vous pouvez vÃ©rifier que la table a bien Ã©tÃ©
supprimÃ©e en visualisant la base de donnÃ©es dans Visual Studio Code.

L'injection SQL a bien fonctionnÃ© et la table `pets` a Ã©tÃ© supprimÃ©e de la base
de donnÃ©es avec succÃ¨s !

AprÃ¨s avoir tout cassÃ© (ğŸ˜ˆ), vous pouvez restaurer la base de donnÃ©es Ã  l'aide
de la copie de sauvegarde que vous avez faite Ã  l'Ã©tape prÃ©cÃ©dente et vous allez
corriger la vulnÃ©rabilitÃ©.

### Ã‰tape 4 : corriger la vulnÃ©rabilitÃ©

Pour corriger la vulnÃ©rabilitÃ©, vous devez utiliser des requÃªtes prÃ©parÃ©es pour
Ã©viter l'injection SQL.

Dans les sections qui suivent, nous allons corriger notre application PHP pour
Ã©viter les injections SQL Ã  tous les endroits oÃ¹ elles sont possibles.

#### `addPet()`

Mettez Ã  jour la fonction `addPet()` pour utiliser une requÃªte prÃ©parÃ©e au lieu
d'une requÃªte SQL brute :

```php
function addPet(
    $name,
    $species,
    $nickname,
    $sex,
    $age,
    $color,
    $personalities,
    $size,
    $notes
) {
    // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pdo`.
    // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
    global $pdo;

    // On transforme le tableau `$personalities` en chaÃ®ne de caractÃ¨res avec `implode`
    $personalitiesAsString = implode(',', $personalities);

    // On dÃ©finit la requÃªte SQL pour ajouter un animal
    $sql = "INSERT INTO pets (
        name,
        species,
        nickname,
        sex,
        age,
        color,
        personalities,
        size,
        notes
    ) VALUES (
        :name,
        :species,
        :nickname,
        :sex,
        :age,
        :color,
        :personalities,
        :size,
        :notes
    )";

    // On prÃ©pare la requÃªte SQL
    $stmt = $pdo->prepare($sql);

    // On lie les paramÃ¨tres
    $stmt->bindValue(':name', $name);
    $stmt->bindValue(':species', $species);
    $stmt->bindValue(':nickname', $nickname);
    $stmt->bindValue(':sex', $sex);
    $stmt->bindValue(':age', $age);
    $stmt->bindValue(':color', $color);
    $stmt->bindValue(':personalities', $personalitiesAsString);
    $stmt->bindValue(':size', $size);
    $stmt->bindValue(':notes', $notes);

    // On exÃ©cute la requÃªte SQL pour ajouter un animal
    $stmt->execute();

    // On rÃ©cupÃ¨re l'identifiant de l'animal ajoutÃ©
    $petId = $pdo->lastInsertId();

    // On retourne l'identifiant de l'animal ajoutÃ©.
    return $petId;
}
```

<details>
<summary>Afficher les diffÃ©rences entre la version vulnÃ©rable et la version corrigÃ©e</summary>

```diff
 <?php
 // Inclusion du fichier de connexion Ã  la base de donnÃ©es
 require './database.php';

 function getPets() {
     // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pdo`.
     // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
     global $pdo;

     // On dÃ©finit la requÃªte SQL pour rÃ©cupÃ©rer tous les animaux
     $sql = "SELECT * FROM pets";

     // On rÃ©cupÃ¨re tous les animaux
     $pets = $pdo->query($sql);

     // On transforme le rÃ©sultat en tableau associatif
     $pets = $pets->fetchAll();

     // On transforme la chaÃ®ne `personalities` en tableau pour chaque animal
     foreach ($pets as &$pet) {
         if (!empty($pet['personalities'])) {
             $pet['personalities'] = explode(',', $pet['personalities']);
         }
     }

     // On retourne tous les animaux
     return $pets;
 }

 function getPet($id) {
     // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pdo`.
     // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
     global $pdo;

     // On dÃ©finit la requÃªte SQL pour rÃ©cupÃ©rer un animal
     $sql = "SELECT * FROM pets WHERE id = '$id'";

     // On rÃ©cupÃ¨re l'animal spÃ©cifique
     $pet = $pdo->query($sql);

     // On transforme le rÃ©sultat en tableau associatif
     $pet = $pet->fetch();

     // On transforme la chaÃ®ne `personalities` en tableau si elle existe
     if ($pet && !empty($pet['personalities'])) {
         $pet['personalities'] = explode(',', $pet['personalities']);
     }

     // On retourne l'animal
     return $pet;
 }

 function addPet(
     $name,
     $species,
     $nickname,
     $sex,
     $age,
     $color,
     $personalities,
     $size,
     $notes
 ) {
     // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pdo`.
     // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
     global $pdo;

     // On transforme le tableau `$personalities` en chaÃ®ne de caractÃ¨res avec `implode`
     $personalitiesAsString = implode(',', $personalities);

     // On dÃ©finit la requÃªte SQL pour ajouter un animal
     $sql = "INSERT INTO pets (
         name,
         species,
         nickname,
         sex,
         age,
         color,
         personalities,
         size,
         notes
     ) VALUES (
-        '$name',
-        '$species',
-        '$nickname',
-        '$sex',
-        $age,
-        '$color',
-        '$personalitiesAsString',
-        $size,
-        '$notes'
+        :name,
+        :species,
+        :nickname,
+        :sex,
+        :age,
+        :color,
+        :personalities,
+        :size,
+        :notes
     )";

+    // On prÃ©pare la requÃªte SQL
+    $stmt = $pdo->prepare($sql);
+
+    // On lie les paramÃ¨tres
+    $stmt->bindValue(':name', $name);
+    $stmt->bindValue(':species', $species);
+    $stmt->bindValue(':nickname', $nickname);
+    $stmt->bindValue(':sex', $sex);
+    $stmt->bindValue(':age', $age);
+    $stmt->bindValue(':color', $color);
+    $stmt->bindValue(':personalities', $personalitiesAsString);
+    $stmt->bindValue(':size', $size);
+    $stmt->bindValue(':notes', $notes);
+
     // On exÃ©cute la requÃªte SQL pour ajouter un animal
-    $pdo->exec($sql);
+    $stmt->execute();

     // On rÃ©cupÃ¨re l'identifiant de l'animal ajoutÃ©
     $petId = $pdo->lastInsertId();

     // On retourne l'identifiant de l'animal ajoutÃ©.
     return $petId;
 }

 function updatePet($name, $age) {
     // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pets`.
     // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
     global $pets;

     // On vÃ©rifie si l'animal existe bien...
     if (array_key_exists($name, $pets)) {
         // ...si l'animal existe, on le rÃ©cupÃ¨re.
         $pet = $pets[$name];

         // On met Ã  jour l'Ã¢ge de l'animal.
         $pet['age'] = $age;

         // On met Ã  jour l'animal dans le tableau `$pets`.
         $pets[$name] = $pet;

         // On retourne l'animal mis Ã  jour.
         return $pet;
     } else {
         // ...si l'animal n'existe pas, on retourne `false`.
         return false;
     }
 }

 function removePet($id) {
     // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pdo`.
     // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
     global $pdo;

     // On dÃ©finit la requÃªte SQL pour supprimer un animal
     $sql = "DELETE FROM pets WHERE id = '$id'";

     // On exÃ©cute la requÃªte SQL pour supprimer un animal
     return $pdo->exec($sql);
 }
```

</details>

Essayez maintenant d'insÃ©rer Ã  nouveau l'animal de compagnie `Fluffy` avec la
requÃªte SQL que vous avez formÃ©e Ã  l'Ã©tape prÃ©cÃ©dente.

Fluffy devrait Ãªtre insÃ©rÃ© dans la base de donnÃ©es sans problÃ¨me et la table
`pets` ne devrait pas Ãªtre supprimÃ©e. Les notes de l'animal de compagnie seront
littÃ©ralement `'); DROP TABLE pets; --` et ne seront pas interprÃ©tÃ©es comme une
requÃªte SQL.

En corrigeant la vulnÃ©rabilitÃ©, vous avez sÃ©curisÃ© l'application contre les
injections SQL.

De plus, vous avez rÃ©solu le problÃ¨me de ne pas pouvoir insÃ©rer des valeurs
contenant des apostrophes (`'`) dans les champs de texte Ã©voquÃ©s lors du
prÃ©cÃ©dent mini-projet. Maintenant, vous pouvez insÃ©rer des valeurs contenant des
apostrophes sans problÃ¨me !

#### `removePet()`

La fonction `removePet()` est Ã©galement vulnÃ©rable aux injections SQL. Vous
devez donc la corriger de la mÃªme maniÃ¨re que la fonction `addPet()` :

```php
function removePet($id) {
    // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pdo`.
    // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
    global $pdo;

    // On dÃ©finit la requÃªte SQL pour supprimer un animal
    $sql = "DELETE FROM pets WHERE id = :id";

    // On prÃ©pare la requÃªte SQL
    $stmt = $pdo->prepare($sql);

    // On lie le paramÃ¨tre
    $stmt->bindValue(':id', $id);

    // On exÃ©cute la requÃªte SQL pour supprimer un animal
    return $stmt->execute();
}
```

<details>
<summary>Afficher les diffÃ©rences entre la version vulnÃ©rable et la version corrigÃ©e</summary>

```diff
 <?php
 // Inclusion du fichier de connexion Ã  la base de donnÃ©es
 require './database.php';

 function getPets() {
     // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pdo`.
     // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
     global $pdo;

     // On dÃ©finit la requÃªte SQL pour rÃ©cupÃ©rer tous les animaux
     $sql = "SELECT * FROM pets";

     // On rÃ©cupÃ¨re tous les animaux
     $pets = $pdo->query($sql);

     // On transforme le rÃ©sultat en tableau associatif
     $pets = $pets->fetchAll();

     // On transforme la chaÃ®ne `personalities` en tableau pour chaque animal
     foreach ($pets as &$pet) {
         if (!empty($pet['personalities'])) {
             $pet['personalities'] = explode(',', $pet['personalities']);
         }
     }

     // On retourne tous les animaux
     return $pets;
 }

 function getPet($id) {
     // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pdo`.
     // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
     global $pdo;

     // On dÃ©finit la requÃªte SQL pour rÃ©cupÃ©rer un animal
     $sql = "SELECT * FROM pets WHERE id = '$id'";

     // On rÃ©cupÃ¨re l'animal spÃ©cifique
     $pet = $pdo->query($sql);

     // On transforme le rÃ©sultat en tableau associatif
     $pet = $pet->fetch();

     // On transforme la chaÃ®ne `personalities` en tableau si elle existe
     if ($pet && !empty($pet['personalities'])) {
         $pet['personalities'] = explode(',', $pet['personalities']);
     }

     // On retourne l'animal
     return $pet;
 }

 function addPet(
     $name,
     $species,
     $nickname,
     $sex,
     $age,
     $color,
     $personalities,
     $size,
     $notes
 ) {
     // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pdo`.
     // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
     global $pdo;

     // On transforme le tableau `$personalities` en chaÃ®ne de caractÃ¨res avec `implode`
     $personalitiesAsString = implode(',', $personalities);

     // On dÃ©finit la requÃªte SQL pour ajouter un animal
     $sql = "INSERT INTO pets (
         name,
         species,
         nickname,
         sex,
         age,
         color,
         personalities,
         size,
         notes
     ) VALUES (
         :name,
         :species,
         :nickname,
         :sex,
         :age,
         :color,
         :personalities,
         :size,
         :notes
     )";

     // On prÃ©pare la requÃªte SQL
     $stmt = $pdo->prepare($sql);

     // On lie les paramÃ¨tres
     $stmt->bindValue(':name', $name);
     $stmt->bindValue(':species', $species);
     $stmt->bindValue(':nickname', $nickname);
     $stmt->bindValue(':sex', $sex);
     $stmt->bindValue(':age', $age);
     $stmt->bindValue(':color', $color);
     $stmt->bindValue(':personalities', $personalitiesAsString);
     $stmt->bindValue(':size', $size);
     $stmt->bindValue(':notes', $notes);

     // On exÃ©cute la requÃªte SQL pour ajouter un animal
     $stmt->execute();

     // On rÃ©cupÃ¨re l'identifiant de l'animal ajoutÃ©
     $petId = $pdo->lastInsertId();

     // On retourne l'identifiant de l'animal ajoutÃ©.
     return $petId;
 }

 function updatePet($name, $age) {
     // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pets`.
     // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
     global $pets;

     // On vÃ©rifie si l'animal existe bien...
     if (array_key_exists($name, $pets)) {
         // ...si l'animal existe, on le rÃ©cupÃ¨re.
         $pet = $pets[$name];

         // On met Ã  jour l'Ã¢ge de l'animal.
         $pet['age'] = $age;

         // On met Ã  jour l'animal dans le tableau `$pets`.
         $pets[$name] = $pet;

         // On retourne l'animal mis Ã  jour.
         return $pet;
     } else {
         // ...si l'animal n'existe pas, on retourne `false`.
         return false;
     }
 }

 function removePet($id) {
     // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pdo`.
     // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
     global $pdo;

     // On dÃ©finit la requÃªte SQL pour supprimer un animal
-    $sql = "DELETE FROM pets WHERE id = '$id'";
+    $sql = "DELETE FROM pets WHERE id = :id";
+
+    // On prÃ©pare la requÃªte SQL
+    $stmt = $pdo->prepare($sql);
+
+    // On lie le paramÃ¨tre
+    $stmt->bindValue(':id', $id);

     // On exÃ©cute la requÃªte SQL pour supprimer un animal
-    return $pdo->exec($sql);
+    return $stmt->execute();
 }
```

</details>

La fonction `removePet()` est maintenant sÃ©curisÃ©e contre les injections SQL.

#### `getPet()`

La fonction `getPet()` est Ã©galement vulnÃ©rable aux injections SQL. Vous devez
donc la corriger de la mÃªme maniÃ¨re que la fonction `addPet()` :

```php
function removePet($id) {
    // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pdo`.
    // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
    global $pdo;

    // On dÃ©finit la requÃªte SQL pour supprimer un animal
    $sql = "DELETE FROM pets WHERE id = :id";

    // On prÃ©pare la requÃªte SQL
    $stmt = $pdo->prepare($sql);

    // On lie le paramÃ¨tre
    $stmt->bindValue(':id', $id);

    // On exÃ©cute la requÃªte SQL pour supprimer un animal
    return $stmt->execute();
}
```

<details>
<summary>Afficher les diffÃ©rences entre la version vulnÃ©rable et la version corrigÃ©e</summary>

```diff
 <?php
 // Inclusion du fichier de connexion Ã  la base de donnÃ©es
 require './database.php';

 function getPets() {
     // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pdo`.
     // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
     global $pdo;

     // On dÃ©finit la requÃªte SQL pour rÃ©cupÃ©rer tous les animaux
     $sql = "SELECT * FROM pets";

     // On rÃ©cupÃ¨re tous les animaux
     $pets = $pdo->query($sql);

     // On transforme le rÃ©sultat en tableau associatif
     $pets = $pets->fetchAll();

     // On transforme la chaÃ®ne `personalities` en tableau pour chaque animal
     foreach ($pets as &$pet) {
         if (!empty($pet['personalities'])) {
             $pet['personalities'] = explode(',', $pet['personalities']);
         }
     }

     // On retourne tous les animaux
     return $pets;
 }

 function getPet($id) {
     // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pdo`.
     // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
     global $pdo;

     // On dÃ©finit la requÃªte SQL pour rÃ©cupÃ©rer un animal
     $sql = "SELECT * FROM pets WHERE id = :id";

     // On prÃ©pare la requÃªte SQL
     $stmt = $pdo->prepare($sql);

     // On lie le paramÃ¨tre
     $stmt->bindValue(':id', $id);

     // On exÃ©cute la requÃªte SQL
     $stmt->execute();

     // On rÃ©cupÃ¨re le rÃ©sultat comme tableau associatif
     $pet = $stmt->fetch();

     // On transforme la chaÃ®ne `personalities` en tableau si elle existe
     if ($pet && !empty($pet['personalities'])) {
         $pet['personalities'] = explode(',', $pet['personalities']);
     }

     // On retourne l'animal
     return $pet;
 }

 function addPet(
     $name,
     $species,
     $nickname,
     $sex,
     $age,
     $color,
     $personalities,
     $size,
     $notes
 ) {
     // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pdo`.
     // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
     global $pdo;

     // On transforme le tableau `$personalities` en chaÃ®ne de caractÃ¨res avec `implode`
     $personalitiesAsString = implode(',', $personalities);

     // On dÃ©finit la requÃªte SQL pour ajouter un animal
     $sql = "INSERT INTO pets (
         name,
         species,
         nickname,
         sex,
         age,
         color,
         personalities,
         size,
         notes
     ) VALUES (
         :name,
         :species,
         :nickname,
         :sex,
         :age,
         :color,
         :personalities,
         :size,
         :notes
     )";

     // On prÃ©pare la requÃªte SQL
     $stmt = $pdo->prepare($sql);

     // On lie les paramÃ¨tres
     $stmt->bindValue(':name', $name);
     $stmt->bindValue(':species', $species);
     $stmt->bindValue(':nickname', $nickname);
     $stmt->bindValue(':sex', $sex);
     $stmt->bindValue(':age', $age);
     $stmt->bindValue(':color', $color);
     $stmt->bindValue(':personalities', $personalitiesAsString);
     $stmt->bindValue(':size', $size);
     $stmt->bindValue(':notes', $notes);

     // On exÃ©cute la requÃªte SQL pour ajouter un animal
     $stmt->execute();

     // On rÃ©cupÃ¨re l'identifiant de l'animal ajoutÃ©
     $petId = $pdo->lastInsertId();

     // On retourne l'identifiant de l'animal ajoutÃ©.
     return $petId;
 }

 function updatePet($name, $age) {
     // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pets`.
     // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
     global $pets;

     // On vÃ©rifie si l'animal existe bien...
     if (array_key_exists($name, $pets)) {
         // ...si l'animal existe, on le rÃ©cupÃ¨re.
         $pet = $pets[$name];

         // On met Ã  jour l'Ã¢ge de l'animal.
         $pet['age'] = $age;

         // On met Ã  jour l'animal dans le tableau `$pets`.
         $pets[$name] = $pet;

         // On retourne l'animal mis Ã  jour.
         return $pet;
     } else {
         // ...si l'animal n'existe pas, on retourne `false`.
         return false;
     }
 }

 function removePet($id) {
     // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pdo`.
     // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
     global $pdo;

     // On dÃ©finit la requÃªte SQL pour supprimer un animal
-    $sql = "DELETE FROM pets WHERE id = '$id'";
+    $sql = "DELETE FROM pets WHERE id = :id";
+
+    // On prÃ©pare la requÃªte SQL
+    $stmt = $pdo->prepare($sql);
+
+    // On lie le paramÃ¨tre
+    $stmt->bindValue(':id', $id);

     // On exÃ©cute la requÃªte SQL pour supprimer un animal
-    return $pdo->exec($sql);
+    return $stmt->execute();
 }
```

</details>

La fonction `getPet()` est maintenant sÃ©curisÃ©e contre les injections SQL.

#### `getPets()`

La fonction `getPets()` n'est pas vulnÃ©rable aux injections SQL car elle ne
accepte pas de paramÃ¨tres. Cependant, il est recommandÃ© de la modifier pour
utiliser une requÃªte prÃ©parÃ©e pour des raisons de cohÃ©rence et de sÃ©curitÃ© :

```php
function getPets() {
    // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pdo`.
    // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
    global $pdo;

    // On dÃ©finit la requÃªte SQL pour rÃ©cupÃ©rer tous les animaux
    $sql = "SELECT * FROM pets";

    // On prÃ©pare la requÃªte SQL
    $stmt = $pdo->prepare($sql);

    // On exÃ©cute la requÃªte SQL
    $stmt->execute();

    // On rÃ©cupÃ¨re tous les animaux
    $pets = $stmt->fetchAll();

    // On transforme la chaÃ®ne `personalities` en tableau pour chaque animal
    foreach ($pets as &$pet) {
        if (!empty($pet['personalities'])) {
            $pet['personalities'] = explode(',', $pet['personalities']);
        }
    }

    // On retourne tous les animaux
    return $pets;
}
```

<details>
<summary>Afficher les diffÃ©rences entre la version vulnÃ©rable et la version corrigÃ©e</summary>

```diff
 <?php
 // Inclusion du fichier de connexion Ã  la base de donnÃ©es
 require './database.php';

 function getPets() {
     // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pdo`.
     // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
     global $pdo;

     // On dÃ©finit la requÃªte SQL pour rÃ©cupÃ©rer tous les animaux
     $sql = "SELECT * FROM pets";

-    // On rÃ©cupÃ¨re tous les animaux
-    $pets = $pdo->query($sql);
+    // On prÃ©pare la requÃªte SQL
+    $stmt = $pdo->prepare($sql);

-    // On transforme le rÃ©sultat en tableau associatif
-    $pets = $pets->fetchAll();
+    // On exÃ©cute la requÃªte SQL
+    $stmt->execute();
+
+    // On rÃ©cupÃ¨re tous les animaux
+    $pets = $stmt->fetchAll();

     // On transforme la chaÃ®ne `personalities` en tableau pour chaque animal
     foreach ($pets as &$pet) {
         if (!empty($pet['personalities'])) {
             $pet['personalities'] = explode(',', $pet['personalities']);
         }
     }

     // On retourne tous les animaux
     return $pets;
 }

 function getPet($id) {
     // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pdo`.
     // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
     global $pdo;

     // On dÃ©finit la requÃªte SQL pour rÃ©cupÃ©rer un animal
     $sql = "SELECT * FROM pets WHERE id = :id";

     // On prÃ©pare la requÃªte SQL
     $stmt = $pdo->prepare($sql);

     // On lie le paramÃ¨tre
     $stmt->bindValue(':id', $id);

     // On exÃ©cute la requÃªte SQL
     $stmt->execute();

     // On rÃ©cupÃ¨re le rÃ©sultat comme tableau associatif
     $pet = $stmt->fetch();

     // On transforme la chaÃ®ne `personalities` en tableau si elle existe
     if ($pet && !empty($pet['personalities'])) {
         $pet['personalities'] = explode(',', $pet['personalities']);
     }

     // On retourne l'animal
     return $pet;
 }

 function addPet(
     $name,
     $species,
     $nickname,
     $sex,
     $age,
     $color,
     $personalities,
     $size,
     $notes
 ) {
     // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pdo`.
     // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
     global $pdo;

     // On transforme le tableau `$personalities` en chaÃ®ne de caractÃ¨res avec `implode`
     $personalitiesAsString = implode(',', $personalities);

     // On dÃ©finit la requÃªte SQL pour ajouter un animal
     $sql = "INSERT INTO pets (
         name,
         species,
         nickname,
         sex,
         age,
         color,
         personalities,
         size,
         notes
     ) VALUES (
         :name,
         :species,
         :nickname,
         :sex,
         :age,
         :color,
         :personalities,
         :size,
         :notes
     )";

     // On prÃ©pare la requÃªte SQL
     $stmt = $pdo->prepare($sql);

     // On lie les paramÃ¨tres
     $stmt->bindValue(':name', $name);
     $stmt->bindValue(':species', $species);
     $stmt->bindValue(':nickname', $nickname);
     $stmt->bindValue(':sex', $sex);
     $stmt->bindValue(':age', $age);
     $stmt->bindValue(':color', $color);
     $stmt->bindValue(':personalities', $personalitiesAsString);
     $stmt->bindValue(':size', $size);
     $stmt->bindValue(':notes', $notes);

     // On exÃ©cute la requÃªte SQL pour ajouter un animal
     $stmt->execute();

     // On rÃ©cupÃ¨re l'identifiant de l'animal ajoutÃ©
     $petId = $pdo->lastInsertId();

     // On retourne l'identifiant de l'animal ajoutÃ©.
     return $petId;
 }

 function updatePet($name, $age) {
     // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pets`.
     // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
     global $pets;

     // On vÃ©rifie si l'animal existe bien...
     if (array_key_exists($name, $pets)) {
         // ...si l'animal existe, on le rÃ©cupÃ¨re.
         $pet = $pets[$name];

         // On met Ã  jour l'Ã¢ge de l'animal.
         $pet['age'] = $age;

         // On met Ã  jour l'animal dans le tableau `$pets`.
         $pets[$name] = $pet;

         // On retourne l'animal mis Ã  jour.
         return $pet;
     } else {
         // ...si l'animal n'existe pas, on retourne `false`.
         return false;
     }
 }

 function removePet($id) {
     // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pdo`.
     // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
     global $pdo;

     // On dÃ©finit la requÃªte SQL pour supprimer un animal
     $sql = "DELETE FROM pets WHERE id = :id";

     // On prÃ©pare la requÃªte SQL
     $stmt = $pdo->prepare($sql);

     // On lie le paramÃ¨tre
     $stmt->bindValue(':id', $id);

     // On exÃ©cute la requÃªte SQL pour supprimer un animal
     return $stmt->execute();
 }
```

</details>

La fonction `getPets()` est maintenant sÃ©curisÃ©e contre les injections SQL.

### Ã‰tape 5 : tester l'application

Une fois que vous avez corrigÃ© toutes les vulnÃ©rabilitÃ©s, testez l'application
pour vous assurer que tout fonctionne correctement :

- Ajoutez un animal de compagnie avec un nom contenant une apostrophe (`'`) et
  vÃ©rifiez que l'animal est ajoutÃ© correctement.
- Essayez d'insÃ©rer un animal de compagnie avec un nom contenant du code
  JavaScript malveillant et vÃ©rifiez que le code n'est pas exÃ©cutÃ©.
- Essayez de supprimer un animal de compagnie et vÃ©rifiez que l'animal est
  supprimÃ© correctement.

Vous avez maintenant sÃ©curisÃ© votre application PHP contre les injections SQL !

## RÃ©aliser une attaque XSS

Dans cette section, vous allez rÃ©aliser une attaque XSS sur l'application PHP
que vous avez dÃ©veloppÃ©e dans le mini-projet prÃ©cÃ©dent.

Puis, vous allez corriger toutes les vulnÃ©rabilitÃ©s d'attaques XSS pour
sÃ©curiser votre application.

### Ã‰tape 1 : identifier une vulnÃ©rabilitÃ©

L'application PHP que vous avez dÃ©veloppÃ©e dans le mini-projet prÃ©cÃ©dent est
vulnÃ©rable aux attaques XSS. En effet, lorsque vous ajoutez un animal de
compagnie, le nom de l'animal est directement affichÃ© sur la page d'accueil sans
aucun filtrage ni Ã©chappement :

```php
            <?php foreach ($pets as $pet) { ?>
                <tr>
                    <td><?= $pet['name'] ?></td>
                    <td><?= $pet['species'] ?></td>
                    <td><?= $pet['sex'] ?></td>
                    <td><?= $pet['age'] ?></td>
                    <td>
                        <a href="delete.php?id=<?= $pet['id'] ?>"><button>Supprimer</button></a>
                        <a href="view.php?id=<?= $pet['id'] ?>"><button>Visualiser</button></a>
                    </td>
                </tr>
            <?php } ?>
```

Cela signifie qu'un attaquant peut facilement injecter du code JavaScript
malveillant dans le nom de l'animal.

### Ã‰tape 2 : rÃ©aliser l'attaque XSS

Pour rÃ©aliser l'attaque XSS, insÃ©rez un animal de compagnie avec un nom qui
contient du code JavaScript malveillant :

- Nom : `<script>alert('Suis le lapin blanc')</script>`
- EspÃ¨ce : `Lapin`
- Surnom : `Trinity`
- Sexe : `Femelle`
- Ã‚ge : `33`
- Couleur : `Blanc`
- PersonnalitÃ©s : `Curieuse`
- Taille : `172`
- Notes : `Tu appartiens Ã  la matrice.`

Une fois l'animal de compagnie insÃ©rÃ©, vous serez automatiquement redirigÃ© sur
la page d'accueil.

Vous devriez voir une boÃ®te de dialogue d'alerte contenant le message "Suis le
lapin blanc" lorsque la page sera chargÃ©e.

Le code JavaScript malveillant a Ã©tÃ© exÃ©cutÃ© car il a Ã©tÃ© injectÃ© dans le nom de
l'animal et affichÃ© sur la page sans Ãªtre Ã©chappÃ©.

### Ã‰tape 3 : corriger la vulnÃ©rabilitÃ©

Pour corriger la vulnÃ©rabilitÃ©, vous devez Ã©chapper les donnÃ©es avant de les
afficher sur la page.

Dans les sections qui suivent, nous allons corriger notre application PHP pour
Ã©viter les attaques XSS Ã  tous les endroits oÃ¹ elles sont possibles.

#### `index.php`

Mettez Ã  jour le fichier `index.php` pour Ã©chapper les donnÃ©es avant de les
afficher sur la page :

```php
            <?php foreach ($pets as $pet) { ?>
                <tr>
                    <td><?= htmlspecialchars($pet['name']) ?></td>
                    <td><?= htmlspecialchars($pet['species']) ?></td>
                    <td><?= htmlspecialchars($pet['sex']) ?></td>
                    <td><?= htmlspecialchars($pet['age']) ?></td>
                    <td>
                        <a href="delete.php?id=<?= htmlspecialchars($pet['id']) ?>"><button>Supprimer</button></a>
                        <a href="view.php?id=<?= htmlspecialchars($pet['id']) ?>"><button>Visualiser</button></a>
                    </td>
                </tr>
            <?php } ?>
```

<details>
<summary>Afficher les diffÃ©rences entre la version vulnÃ©rable et la version corrigÃ©e</summary>

```diff
 <?php
 require 'functions.php';

 // RÃ©cupÃ¨re tous les animaux
 $pets = getPets();
 ?>

 <!DOCTYPE html>
 <html lang="fr">

 <head>
     <title>Page d'accueil | Gestionnaire d'animaux de compagnie</title>

     <style>
         table,
         th,
         td {
             border: 1px solid black;
             border-collapse: collapse;
             padding: 8px;
         }
     </style>
 </head>

 <body>
     <h1>Page d'accueil du gestionnaire d'animaux de compagnie</h1>
     <p>Bienvenue sur la page d'accueil du gestionnaire d'animaux de compagnie !</p>
     <p>Utilise cette page pour visualiser et gÃ©rer tous les animaux de compagnie.</p>

     <h2>Liste des animaux</h2>

     <p><a href="create.php"><button>CrÃ©er un nouvel animal de compagnie</button></a></p>

     <table>
         <thead>
             <tr>
                 <th>Nom</th>
                 <th>EspÃ¨ce</th>
                 <th>Sexe</th>
                 <th>Ã‚ge</th>
                 <th>Actions</th>
             </tr>
         </thead>
         <tbody>
             <?php foreach ($pets as $pet) { ?>
                 <tr>
-                    <td><?= $pet['name'] ?></td>
-                    <td><?= $pet['species'] ?></td>
-                    <td><?= $pet['sex'] ?></td>
-                    <td><?= $pet['age'] ?></td>
+                    <td><?= htmlspecialchars($pet['name']) ?></td>
+                    <td><?= htmlspecialchars($pet['species']) ?></td>
+                    <td><?= htmlspecialchars($pet['sex']) ?></td>
+                    <td><?= htmlspecialchars($pet['age']) ?></td>
                     <td>
-                        <a href="delete.php?id=<?= $pet['id'] ?>"><button>Supprimer</button></a>
-                        <a href="view.php?id=<?= $pet['id'] ?>"><button>Visualiser</button></a>
+                        <a href="delete.php?id=<?= htmlspecialchars($pet['id']) ?>"><button>Supprimer</button></a>
+                        <a href="view.php?id=<?= htmlspecialchars($pet['id']) ?>"><button>Visualiser</button></a>
                    </td>
                 </tr>
             <?php } ?>
         </tbody>
     </table>
 </body>

 </html>
```

</details>

En utilisant la fonction `htmlspecialchars()`, vous Ã©chappez les caractÃ¨res
spÃ©ciaux HTML dans tous les champs affichÃ©s sur la page.

Cela signifie que le code JavaScript malveillant ne sera pas exÃ©cutÃ© lorsque la
page sera chargÃ©e.

Essayez maintenant Ã  nouveau de rafraÃ®chir la page d'accueil. Vous ne devriez
plus voir la boÃ®te de dialogue d'alerte contenant le message "Suis le lapin
blanc".

Le nom de l'animal est maintenant affichÃ© correctement sans exÃ©cuter le code
JavaScript malveillant.

En corrigeant la vulnÃ©rabilitÃ©, vous avez sÃ©curisÃ© l'application contre les
attaques XSS.

#### `view.php`

La page `view.php` est Ã©galement vulnÃ©rable aux attaques XSS. Vous devez donc la
corriger de la mÃªme maniÃ¨re que la page `index.php` :

```php
<?php
require 'functions.php';

// On vÃ©rifie si l'ID de l'animal est passÃ© dans l'URL
if (isset($_GET["id"])) {
    // On rÃ©cupÃ¨re l'ID de l'animal de la superglobale `$_GET`
    $petId = $_GET["id"];

    // On rÃ©cupÃ¨re l'animal correspondant Ã  l'ID
    $pet = getPet($petId);

    // Si l'animal n'existe pas, on redirige vers la page d'accueil
    if (!$pet) {
        header("Location: index.php");
        exit();
    }
} else {
    // Si l'ID n'est pas passÃ© dans l'URL, on redirige vers la page d'accueil
    header("Location: index.php");
    exit();
}
?>

<!DOCTYPE html>
<html lang="fr">

<head>
    <title>Visualise et modifie un animal de compagnie | Gestionnaire d'animaux de compagnie</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
            color: #333;
        }

        h1 {
            text-align: center;
            color: #444;
        }

        p {
            text-align: center;
        }

        form {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        label {
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="number"],
        input[type="color"],
        textarea,
        select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        input[type="radio"],
        input[type="checkbox"] {
            margin-right: 5px;
        }

        input[type="radio"]+label,
        input[type="checkbox"]+label {
            display: inline-block;
            margin-right: 15px;
        }

        fieldset div {
            display: inline-block;
            margin-right: 10px;
        }

        fieldset {
            margin-top: 5px;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        legend {
            font-weight: bold;
        }

        button {
            display: block;
            width: 100%;
            padding: 10px;
            background-color: #5cb85c;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }

        button:hover {
            background-color: #4cae4c;
        }

        a {
            color: #5cb85c;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <h1>Visualise un animal de compagnie</h1>
    <p><a href="index.php">Retour Ã  l'accueil</a></p>
    <p>Utilise cette page pour visualiser un animal de compagnie.</p>

    <form>
        <label for="name">Nom :</label><br>
        <input type="text" id="name" value="<?= htmlspecialchars($pet["name"]) ?>" disabled />

        <br>

        <label for="species">EspÃ¨ce :</label><br>
        <select id="species" disabled>
            <option value="dog" <?= htmlspecialchars($pet["species"]) == "dog" ? "selected" : "" ?>>Chien</option>
            <option value="cat" <?= htmlspecialchars($pet["species"]) == "cat" ? "selected" : "" ?>>Chat</option>
            <option value="lizard" <?= htmlspecialchars($pet["species"]) == "lizard" ? "selected" : "" ?>>LÃ©zard</option>
            <option value="snake" <?= htmlspecialchars($pet["species"]) == "snake" ? "selected" : "" ?>>Serpent</option>
            <option value="bird" <?= htmlspecialchars($pet["species"]) == "bird" ? "selected" : "" ?>>Oiseau</option>
            <option value="rabbit" <?= htmlspecialchars($pet["species"]) == "rabbit" ? "selected" : "" ?>>Lapin</option>
            <option value="other" <?= htmlspecialchars($pet["species"]) == "other" ? "selected" : "" ?>>Autre</option>
        </select>

        <br>

        <label for="nickname">Surnom :</label><br>
        <input type="text" id="nickname" value="<?= htmlspecialchars($pet["nickname"]) ?>" disabled />

        <fieldset>
            <legend>Sexe :</legend>

            <input type="radio" id="male" <?= htmlspecialchars($pet["sex"]) == "male" ? "checked" : "" ?> disabled />
            <label for="male">MÃ¢le</label><br>

            <input type="radio" id="female" <?= htmlspecialchars($pet["sex"]) == "female" ? "checked" : "" ?> disabled />
            <label for="female">Femelle</label>
        </fieldset>

        <br>

        <label for="age">Ã‚ge :</label><br>
        <input type="number" id="age" value="<?= $pet["age"] ?>" disabled />

        <br>

        <label for="color">Couleur :</label><br>
        <input type="color" id="color" value="<?= $pet["color"] ?>" disabled />

        <fieldset>
            <legend>PersonnalitÃ© :</legend>

            <div>
                <input type="checkbox" id="gentil" <?= !empty($pet["personalities"]) && in_array("gentil", $pet["personalities"]) ? "checked" : "" ?> disabled />
                <label for="gentil">Gentil</label>
            </div>

            <div>
                <input type="checkbox" id="playful" <?= !empty($pet["personalities"]) && in_array("playful", $pet["personalities"]) ? "checked" : "" ?> disabled />
                <label for="playful">Joueur</label>
            </div>

            <div>
                <input type="checkbox" id="curious" <?= !empty($pet["personalities"]) && in_array("curious", $pet["personalities"]) ? "checked" : "" ?> disabled />
                <label for="curious">Curieux</label>
            </div>

            <div>
                <input type="checkbox" id="lazy" <?= !empty($pet["personalities"]) && in_array("lazy", $pet["personalities"]) ? "checked" : "" ?> disabled />
                <label for="lazy">Paresseux</label>
            </div>

            <div>
                <input type="checkbox" id="scared" <?= !empty($pet["personalities"]) && in_array("scared", $pet["personalities"]) ? "checked" : "" ?> disabled />
                <label for="scared">Peureux</label>
            </div>

            <div>
                <input type="checkbox" id="aggressive" <?= !empty($pet["personalities"]) && in_array("aggressive", $pet["personalities"]) ? "checked" : "" ?> disabled />
                <label for="aggressive">Agressif</label>
            </div>
        </fieldset>

        <br>

        <label for="size">Taille :</label><br>
        <input type="number" id="size" value="<?= $pet["size"] ?>" disabled />

        <br>

        <label for="notes">Notes :</label><br>
        <textarea id="notes" rows="4" cols="50" disabled><?= $pet["notes"] ?></textarea>

        <br>
        <br>

        <a href="delete.php?id=<?= $pet["id"] ?>">
            <button type="button">Supprimer</button>
        </a><br>
        <a href="edit.php?id=<?= $pet["id"] ?>">
            <button type="button">Mettre Ã  jour</button>
        </a>
    </form>
</body>

</html>
```

<details>
<summary>Afficher les diffÃ©rences entre la version vulnÃ©rable et la version corrigÃ©e</summary>

```diff
 <?php
 require 'functions.php';

 // On vÃ©rifie si l'ID de l'animal est passÃ© dans l'URL
 if (isset($_GET["id"])) {
     // On rÃ©cupÃ¨re l'ID de l'animal de la superglobale `$_GET`
     $petId = $_GET["id"];

     // On rÃ©cupÃ¨re l'animal correspondant Ã  l'ID
     $pet = getPet($petId);

     // Si l'animal n'existe pas, on redirige vers la page d'accueil
     if (!$pet) {
         header("Location: index.php");
         exit();
     }
 } else {
     // Si l'ID n'est pas passÃ© dans l'URL, on redirige vers la page d'accueil
     header("Location: index.php");
     exit();
 }
 ?>

 <!DOCTYPE html>
 <html lang="fr">

 <head>
     <title>Visualise et modifie un animal de compagnie | Gestionnaire d'animaux de compagnie</title>

     <style>
         body {
             font-family: Arial, sans-serif;
             margin: 0;
             padding: 0;
             background-color: #f9f9f9;
             color: #333;
         }

         h1 {
             text-align: center;
             color: #444;
         }

         p {
             text-align: center;
         }

         form {
             max-width: 600px;
             margin: 20px auto;
             padding: 20px;
             background: #fff;
             border: 1px solid #ddd;
             border-radius: 5px;
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
         }

         label {
             margin-bottom: 5px;
             font-weight: bold;
         }

         input[type="text"],
         input[type="number"],
         input[type="color"],
         textarea,
         select {
             width: 100%;
             padding: 8px;
             margin-top: 5px;
             margin-bottom: 15px;
             border: 1px solid #ccc;
             border-radius: 4px;
             box-sizing: border-box;
         }

         input[type="radio"],
         input[type="checkbox"] {
             margin-right: 5px;
         }

         input[type="radio"]+label,
         input[type="checkbox"]+label {
             display: inline-block;
             margin-right: 15px;
         }

         fieldset div {
             display: inline-block;
             margin-right: 10px;
         }

         fieldset {
             margin-top: 5px;
             margin-bottom: 15px;
             padding: 10px;
             border: 1px solid #ccc;
             border-radius: 4px;
         }

         legend {
             font-weight: bold;
         }

         button {
             display: block;
             width: 100%;
             padding: 10px;
             background-color: #5cb85c;
             color: white;
             border: none;
             border-radius: 4px;
             font-size: 16px;
             cursor: pointer;
         }

         button:hover {
             background-color: #4cae4c;
         }

         a {
             color: #5cb85c;
             text-decoration: none;
         }

         a:hover {
             text-decoration: underline;
         }
     </style>
 </head>

 <body>
     <h1>Visualise un animal de compagnie</h1>
     <p><a href="index.php">Retour Ã  l'accueil</a></p>
     <p>Utilise cette page pour visualiser un animal de compagnie.</p>

     <form>
         <label for="name">Nom :</label><br>
-        <input type="text" id="name" value="<?= $pet["name"] ?>" disabled />
+        <input type="text" id="name" value="<?= htmlspecialchars($pet["name"]) ?>" disabled />

         <br>

         <label for="species">EspÃ¨ce :</label><br>
         <select id="species" disabled>
-            <option value="dog" <?= $pet["species"] == "dog" ? "selected" : "" ?>>Chien</option>
-            <option value="cat" <?= $pet["species"] == "cat" ? "selected" : "" ?>>Chat</option>
-            <option value="lizard" <?= $pet["species"] == "lizard" ? "selected" : "" ?>>LÃ©zard</option>
-            <option value="snake" <?= $pet["species"] == "snake" ? "selected" : "" ?>>Serpent</option>
-            <option value="bird" <?= $pet["species"] == "bird" ? "selected" : "" ?>>Oiseau</option>
-            <option value="rabbit" <?= $pet["species"] == "rabbit" ? "selected" : "" ?>>Lapin</option>
-            <option value="other" <?= $pet["species"] == "other" ? "selected" : "" ?>>Autre</option>
+            <option value="dog" <?= htmlspecialchars($pet["species"]) == "dog" ? "selected" : "" ?>>Chien</option>
+            <option value="cat" <?= htmlspecialchars($pet["species"]) == "cat" ? "selected" : "" ?>>Chat</option>
+            <option value="lizard" <?= htmlspecialchars($pet["species"]) == "lizard" ? "selected" : "" ?>>LÃ©zard</option>
+            <option value="snake" <?= htmlspecialchars($pet["species"]) == "snake" ? "selected" : "" ?>>Serpent</option>
+            <option value="bird" <?= htmlspecialchars($pet["species"]) == "bird" ? "selected" : "" ?>>Oiseau</option>
+            <option value="rabbit" <?= htmlspecialchars($pet["species"]) == "rabbit" ? "selected" : "" ?>>Lapin</option>
+            <option value="other" <?= htmlspecialchars($pet["species"]) == "other" ? "selected" : "" ?>>Autre</option>
         </select>

         <br>

         <label for="nickname">Surnom :</label><br>
-        <input type="text" id="nickname" value="<?= $pet["nickname"] ?>" disabled />
+        <input type="text" id="nickname" value="<?= htmlspecialchars($pet["nickname"]) ?>" disabled />

         <fieldset>
             <legend>Sexe :</legend>

-            <input type="radio" id="male" <?= $pet["sex"] == "male" ? "checked" : "" ?> disabled />
+            <input type="radio" id="male" <?= htmlspecialchars($pet["sex"]) == "male" ? "checked" : "" ?> disabled />
             <label for="male">MÃ¢le</label><br>

-            <input type="radio" id="female" <?= $pet["sex"] == "female" ? "checked" : "" ?> disabled />
+            <input type="radio" id="female" <?= htmlspecialchars($pet["sex"]) == "female" ? "checked" : "" ?> disabled />
             <label for="female">Femelle</label>
         </fieldset>

         <br>

         <label for="age">Ã‚ge :</label><br>
         <input type="number" id="age" value="<?= $pet["age"] ?>" disabled />

         <br>

         <label for="color">Couleur :</label><br>
         <input type="color" id="color" value="<?= $pet["color"] ?>" disabled />

         <fieldset>
             <legend>PersonnalitÃ© :</legend>

             <div>
                 <input type="checkbox" id="gentil" <?= !empty($pet["personalities"]) && in_array("gentil", $pet["personalities"]) ? "checked" : "" ?> disabled />
                 <label for="gentil">Gentil</label>
             </div>

             <div>
                 <input type="checkbox" id="playful" <?= !empty($pet["personalities"]) && in_array("playful", $pet["personalities"]) ? "checked" : "" ?> disabled />
                 <label for="playful">Joueur</label>
             </div>

             <div>
                 <input type="checkbox" id="curious" <?= !empty($pet["personalities"]) && in_array("curious", $pet["personalities"]) ? "checked" : "" ?> disabled />
                 <label for="curious">Curieux</label>
             </div>

             <div>
                 <input type="checkbox" id="lazy" <?= !empty($pet["personalities"]) && in_array("lazy", $pet["personalities"]) ? "checked" : "" ?> disabled />
                 <label for="lazy">Paresseux</label>
             </div>

             <div>
                 <input type="checkbox" id="scared" <?= !empty($pet["personalities"]) && in_array("scared", $pet["personalities"]) ? "checked" : "" ?> disabled />
                 <label for="scared">Peureux</label>
             </div>

             <div>
                 <input type="checkbox" id="aggressive" <?= !empty($pet["personalities"]) && in_array("aggressive", $pet["personalities"]) ? "checked" : "" ?> disabled />
                 <label for="aggressive">Agressif</label>
             </div>
         </fieldset>

         <br>

         <label for="size">Taille :</label><br>
         <input type="number" id="size" value="<?= $pet["size"] ?>" disabled />

         <br>

         <label for="notes">Notes :</label><br>
         <textarea id="notes" rows="4" cols="50" disabled><?= $pet["notes"] ?></textarea>

         <br>
         <br>

-        <a href="delete.php?id=<?= $pet["id"] ?>">
+        <a href="delete.php?id=<?= htmlspecialchars($pet["id"]) ?>">
             <button type="button">Supprimer</button>
         </a>
     </form>
 </body>

 </html>
```

</details>

Vous avez maintenant sÃ©curisÃ© la page `view.php` contre les attaques XSS.

#### `create.php`

La page `create.php` est Ã©galement vulnÃ©rable aux attaques XSS. Vous devez donc
la corriger de la mÃªme maniÃ¨re que les pages `index.php` :

```php
<?php
require 'functions.php';

// GÃ¨re la soumission du formulaire
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    // RÃ©cupÃ©ration des donnÃ©es du formulaire
    $name = $_POST["name"];
    $species = $_POST["species"];
    $nickname = $_POST["nickname"];
    $sex = $_POST["sex"];
    $age = $_POST["age"];
    $color = $_POST["color"];
    $personalities = isset($_POST["personalities"]) ? $_POST["personalities"] : [];
    $size = $_POST["size"];
    $notes = $_POST["notes"];

    // Par dÃ©faut, il n'y a pas d'erreurs
    $errors = [];

    // Validation des donnÃ©es
    if (empty($name)) {
        // On ajoute un message d'erreur au tableau
        array_push($errors, "Le nom est obligatoire.");
    }

    if (strlen($name) < 2) {
        // On ajoute un message d'erreur au tableau
        array_push($errors, "Le nom doit contenir au moins 2 caractÃ¨res.");
    }

    if (empty($species)) {
        // On ajoute un message d'erreur au tableau
        array_push($errors, "L'espÃ¨ce est obligatoire.");
    }

    if (empty($sex)) {
        // On ajoute un message d'erreur au tableau
        array_push($errors, "Le sexe est obligatoire.");
    }

    if (empty($age)) {
        // On ajoute un message d'erreur au tableau
        array_push($errors, "L'Ã¢ge est obligatoire.");
    }

    if (!is_numeric($age) || $age < 0) {
        // On ajoute un message d'erreur au tableau
        array_push($errors, "L'Ã¢ge doit Ãªtre un nombre entier positif.");
    }

    if (!empty($size) && (!is_numeric($size) || $size < 0)) {
        // On ajoute un message d'erreur au tableau
        array_push($errors, "La taille doit Ãªtre un nombre entier positif.");
    }

    // Si le formulaire est valide, on ajoute l'animal
    if (empty($errors)) {
        // On ajoute l'animal Ã  la base de donnÃ©es
        $petId = addPet(
            $name,
            $species,
            $nickname,
            $sex,
            $age,
            $color,
            $personalities,
            $size,
            $notes
        );

        // On redirige vers la page d'accueil avec tous les animaux
        header("Location: index.php");
        exit();
    }
}
?>

<!DOCTYPE html>
<html>

<head>
    <title>CrÃ©e un nouvel animal de compagnie | Gestionnaire d'animaux de compagnie</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
            color: #333;
        }

        h1 {
            text-align: center;
            color: #444;
        }

        p {
            text-align: center;
        }

        form {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        label {
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="number"],
        input[type="color"],
        textarea,
        select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        input[type="radio"],
        input[type="checkbox"] {
            margin-right: 5px;
        }

        input[type="radio"]+label,
        input[type="checkbox"]+label {
            display: inline-block;
            margin-right: 15px;
        }

        fieldset div {
            display: inline-block;
            margin-right: 10px;
        }

        fieldset {
            margin-top: 5px;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        legend {
            font-weight: bold;
        }

        button {
            display: block;
            width: 100%;
            padding: 10px;
            background-color: #5cb85c;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }

        button:hover {
            background-color: #4cae4c;
        }

        a {
            color: #5cb85c;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <h1>CrÃ©e un nouvel animal de compagnie</h1>
    <p><a href="index.php">Retour Ã  l'accueil</a></p>
    <p>Utilise cette page pour crÃ©er un nouvel animal de compagnie.</p>

    <?php if ($_SERVER["REQUEST_METHOD"] == "POST") { ?>
        <?php if (empty($errors)) { ?>
            <p style="color: green;">Le formulaire a Ã©tÃ© soumis avec succÃ¨s !</p>
        <?php } else { ?>
            <p style="color: red;">Le formulaire contient des erreurs :</p>
            <ul>
                <?php foreach ($errors as $error) { ?>
                    <li><?php echo $error; ?></li>
                <?php } ?>
            </ul>
        <?php } ?>
    <?php } ?>

    <form action="create.php" method="POST">
        <label for="name">Nom :</label><br>
        <input type="text" id="name" name="name" value="<?php if (isset($name)) echo htmlspecialchars($name); ?>" required minlength="2">

        <br>

        <label for="species">EspÃ¨ce :</label><br>
        <select id="species" name="species" required>
            <option value="dog" <?php if (isset($species) && $species == "dog") echo "selected"; ?>>Chien</option>
            <option value="cat" <?php if (isset($species) && $species == "cat") echo "selected"; ?>>Chat</option>
            <option value="lizard" <?php if (isset($species) && $species == "lizard") echo "selected"; ?>>LÃ©zard</option>
            <option value="snake" <?php if (isset($species) && $species == "snake") echo "selected"; ?>>Serpent</option>
            <option value="bird" <?php if (isset($species) && $species == "bird") echo "selected"; ?>>Oiseau</option>
            <option value="rabbit" <?php if (isset($species) && $species == "rabbit") echo "selected"; ?>>Lapin</option>
            <option value="other" <?php if (isset($species) && $species == "other") echo "selected"; ?>>Autre</option>
        </select>

        <br>

        <label for="nickname">Surnom :</label><br>
        <input type="text" id="nickname" name="nickname" value="<?php if (isset($nickname)) echo htmlspecialchars($nickname); ?>" />

        <fieldset>
            <legend>Sexe :</legend>

            <input type="radio" id="male" name="sex" value="male" <?php echo (isset($sex) && $sex == 'male') ? 'checked' : ''; ?> required />
            <label for="male">MÃ¢le</label><br>

            <input type="radio" id="female" name="sex" value="female" <?php echo (isset($sex) && $sex == 'female') ? 'checked' : ''; ?> required />
            <label for="female">Femelle</label>
        </fieldset>

        <br>

        <label for="age">Ã‚ge :</label><br>
        <input type="number" id="age" name="age" value="<?php if (isset($age)) echo htmlspecialchars($age); ?>" required min="0" />

        <br>

        <label for="color">Couleur :</label><br>
        <input type="color" id="color" name="color" value="<?php if (isset($color)) echo htmlspecialchars($color); ?>" />

        <fieldset>
            <legend>PersonnalitÃ© :</legend>

            <div>
                <input type="checkbox" id="gentil" name="personalities[]" value="gentil" <?php echo (isset($personalities) && in_array("gentil", $personalities)) ? 'checked' : ''; ?> />
                <label for="gentil">Gentil</label>
            </div>

            <div>
                <input type="checkbox" id="playful" name="personalities[]" value="playful" <?php echo (isset($personalities) && in_array("playful", $personalities)) ? 'checked' : ''; ?> />
                <label for="playful">Joueur</label>
            </div>

            <div>
                <input type="checkbox" id="curious" name="personalities[]" value="curious" <?php echo (isset($personalities) && in_array("curious", $personalities)) ? 'checked' : ''; ?> />
                <label for="curious">Curieux</label>
            </div>

            <div>
                <input type="checkbox" id="lazy" name="personalities[]" value="lazy" <?php echo (isset($personalities) && in_array("lazy", $personalities)) ? 'checked' : ''; ?> />
                <label for="lazy">Paresseux</label>
            </div>

            <div>
                <input type="checkbox" id="scared" name="personalities[]" value="scared" <?php echo (isset($personalities) && in_array("scared", $personalities)) ? 'checked' : ''; ?> />
                <label for="scared">Peureux</label>
            </div>

            <div>
                <input type="checkbox" id="aggressive" name="personalities[]" value="aggressive" <?php echo (isset($personalities) && in_array("aggressive", $personalities)) ? 'checked' : ''; ?> />
                <label for="aggressive">Agressif</label>
            </div>
        </fieldset>

        <br>

        <label for="size">Taille :</label><br>
        <input type="number" id="size" name="size" value="<?php if (isset($size)) echo htmlspecialchars($size); ?>" min="0" step="0.1" />

        <br>

        <label for="notes">Notes :</label><br>
        <textarea id="notes" name="notes" rows="4" cols="50"><?php if (isset($notes)) echo htmlspecialchars($notes); ?></textarea>

        <br>
        <br>

        <button type="submit">CrÃ©er</button><br>
        <button type="reset">RÃ©initialiser</button>
    </form>
</body>

</html>
```

<details>
<summary>Afficher les diffÃ©rences entre la version vulnÃ©rable et la version corrigÃ©e</summary>

```diff
 <?php
 require 'functions.php';

 // GÃ¨re la soumission du formulaire
 if ($_SERVER["REQUEST_METHOD"] == "POST") {
     // RÃ©cupÃ©ration des donnÃ©es du formulaire
     $name = $_POST["name"];
     $species = $_POST["species"];
     $nickname = $_POST["nickname"];
     $sex = $_POST["sex"];
     $age = $_POST["age"];
     $color = $_POST["color"];
     $personalities = isset($_POST["personalities"]) ? $_POST["personalities"] : [];
     $size = $_POST["size"];
     $notes = $_POST["notes"];

     // Par dÃ©faut, il n'y a pas d'erreurs
     $errors = [];

     // Validation des donnÃ©es
     if (empty($name)) {
         // On ajoute un message d'erreur au tableau
         array_push($errors, "Le nom est obligatoire.");
     }

     if (strlen($name) < 2) {
         // On ajoute un message d'erreur au tableau
         array_push($errors, "Le nom doit contenir au moins 2 caractÃ¨res.");
     }

     if (empty($species)) {
         // On ajoute un message d'erreur au tableau
         array_push($errors, "L'espÃ¨ce est obligatoire.");
     }

     if (empty($sex)) {
         // On ajoute un message d'erreur au tableau
         array_push($errors, "Le sexe est obligatoire.");
     }

     if (empty($age)) {
         // On ajoute un message d'erreur au tableau
         array_push($errors, "L'Ã¢ge est obligatoire.");
     }

     if (!is_numeric($age) || $age < 0) {
         // On ajoute un message d'erreur au tableau
         array_push($errors, "L'Ã¢ge doit Ãªtre un nombre entier positif.");
     }

     if (!empty($size) && (!is_numeric($size) || $size < 0)) {
         // On ajoute un message d'erreur au tableau
         array_push($errors, "La taille doit Ãªtre un nombre entier positif.");
     }

     // Si le formulaire est valide, on ajoute l'animal
     if (empty($errors)) {
         // On ajoute l'animal Ã  la base de donnÃ©es
         $petId = addPet(
             $name,
             $species,
             $nickname,
             $sex,
             $age,
             $color,
             $personalities,
             $size,
             $notes
         );

         // On redirige vers la page d'accueil avec tous les animaux
         header("Location: index.php");
         exit();
     }
 }
 ?>

 <!DOCTYPE html>
 <html>

 <head>
     <title>CrÃ©e un nouvel animal de compagnie | Gestionnaire d'animaux de compagnie</title>

     <style>
         body {
             font-family: Arial, sans-serif;
             margin: 0;
             padding: 0;
             background-color: #f9f9f9;
             color: #333;
         }

         h1 {
             text-align: center;
             color: #444;
         }

         p {
             text-align: center;
         }

         form {
             max-width: 600px;
             margin: 20px auto;
             padding: 20px;
             background: #fff;
             border: 1px solid #ddd;
             border-radius: 5px;
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
         }

         label {
             margin-bottom: 5px;
             font-weight: bold;
         }

         input[type="text"],
         input[type="number"],
         input[type="color"],
         textarea,
         select {
             width: 100%;
             padding: 8px;
             margin-top: 5px;
             margin-bottom: 15px;
             border: 1px solid #ccc;
             border-radius: 4px;
             box-sizing: border-box;
         }

         input[type="radio"],
         input[type="checkbox"] {
             margin-right: 5px;
         }

         input[type="radio"]+label,
         input[type="checkbox"]+label {
             display: inline-block;
             margin-right: 15px;
         }

         fieldset div {
             display: inline-block;
             margin-right: 10px;
         }

         fieldset {
             margin-top: 5px;
             margin-bottom: 15px;
             padding: 10px;
             border: 1px solid #ccc;
             border-radius: 4px;
         }

         legend {
             font-weight: bold;
         }

         button {
             display: block;
             width: 100%;
             padding: 10px;
             background-color: #5cb85c;
             color: white;
             border: none;
             border-radius: 4px;
             font-size: 16px;
             cursor: pointer;
         }

         button:hover {
             background-color: #4cae4c;
         }

         a {
             color: #5cb85c;
             text-decoration: none;
         }

         a:hover {
             text-decoration: underline;
         }
     </style>
 </head>

 <body>
     <h1>CrÃ©e un nouvel animal de compagnie</h1>
     <p><a href="index.php">Retour Ã  l'accueil</a></p>
     <p>Utilise cette page pour crÃ©er un nouvel animal de compagnie.</p>

     <?php if ($_SERVER["REQUEST_METHOD"] == "POST") { ?>
         <?php if (empty($errors)) { ?>
             <p style="color: green;">Le formulaire a Ã©tÃ© soumis avec succÃ¨s !</p>
         <?php } else { ?>
             <p style="color: red;">Le formulaire contient des erreurs :</p>
             <ul>
                 <?php foreach ($errors as $error) { ?>
                     <li><?php echo $error; ?></li>
                 <?php } ?>
             </ul>
         <?php } ?>
     <?php } ?>

     <form action="create.php" method="POST">
         <label for="name">Nom :</label><br>
-        <input type="text" id="name" name="name" value="<?php if (isset($name)) echo $name; ?>" required minlength="2">
+        <input type="text" id="name" name="name" value="<?php if (isset($name)) echo htmlspecialchars($name); ?>" required minlength="2">

         <br>

         <label for="species">EspÃ¨ce :</label><br>
         <select id="species" name="species" required>
             <option value="dog" <?php if (isset($species) && $species == "dog") echo "selected"; ?>>Chien</option>
             <option value="cat" <?php if (isset($species) && $species == "cat") echo "selected"; ?>>Chat</option>
             <option value="lizard" <?php if (isset($species) && $species == "lizard") echo "selected"; ?>>LÃ©zard</option>
             <option value="snake" <?php if (isset($species) && $species == "snake") echo "selected"; ?>>Serpent</option>
             <option value="bird" <?php if (isset($species) && $species == "bird") echo "selected"; ?>>Oiseau</option>
             <option value="rabbit" <?php if (isset($species) && $species == "rabbit") echo "selected"; ?>>Lapin</option>
             <option value="other" <?php if (isset($species) && $species == "other") echo "selected"; ?>>Autre</option>
         </select>

         <br>

         <label for="nickname">Surnom :</label><br>
-        <input type="text" id="nickname" name="nickname" value="<?php if (isset($nickname)) echo $nickname; ?>" />
+        <input type="text" id="nickname" name="nickname" value="<?php if (isset($nickname)) echo htmlspecialchars($nickname); ?>" />

         <fieldset>
             <legend>Sexe :</legend>

             <input type="radio" id="male" name="sex" value="male" <?php echo (isset($sex) && $sex == 'male') ? 'checked' : ''; ?> required />
             <label for="male">MÃ¢le</label><br>

             <input type="radio" id="female" name="sex" value="female" <?php echo (isset($sex) && $sex == 'female') ? 'checked' : ''; ?> required />
             <label for="female">Femelle</label>
         </fieldset>

         <br>

         <label for="age">Ã‚ge :</label><br>
-        <input type="number" id="age" name="age" value="<?php if (isset($age)) echo $age; ?>" required min="0" />
+        <input type="number" id="age" name="age" value="<?php if (isset($age)) echo htmlspecialchars($age); ?>" required min="0" />

         <br>

         <label for="color">Couleur :</label><br>
-        <input type="color" id="color" name="color" value="<?php if (isset($color)) echo $color; ?>" />
+        <input type="color" id="color" name="color" value="<?php if (isset($color)) echo htmlspecialchars($color); ?>" />

         <fieldset>
             <legend>PersonnalitÃ© :</legend>

             <div>
                 <input type="checkbox" id="gentil" name="personalities[]" value="gentil" <?php echo (isset($personalities) && in_array("gentil", $personal
ities)) ? 'checked' : ''; ?> />
                 <label for="gentil">Gentil</label>
             </div>

             <div>
                 <input type="checkbox" id="playful" name="personalities[]" value="playful" <?php echo (isset($personalities) && in_array("playful", $perso
nalities)) ? 'checked' : ''; ?> />
                 <label for="playful">Joueur</label>
             </div>

             <div>
                 <input type="checkbox" id="curious" name="personalities[]" value="curious" <?php echo (isset($personalities) && in_array("curious", $perso
nalities)) ? 'checked' : ''; ?> />
                 <label for="curious">Curieux</label>
             </div>

             <div>
                 <input type="checkbox" id="lazy" name="personalities[]" value="lazy" <?php echo (isset($personalities) && in_array("lazy", $personalities)
) ? 'checked' : ''; ?> />
                 <label for="lazy">Paresseux</label>
             </div>

             <div>
                 <input type="checkbox" id="scared" name="personalities[]" value="scared" <?php echo (isset($personalities) && in_array("scared", $personal
ities)) ? 'checked' : ''; ?> />
                 <label for="scared">Peureux</label>
             </div>

             <div>
                 <input type="checkbox" id="aggressive" name="personalities[]" value="aggressive" <?php echo (isset($personalities) && in_array("aggressive
", $personalities)) ? 'checked' : ''; ?> />
                 <label for="aggressive">Agressif</label>
             </div>
         </fieldset>

         <br>

         <label for="size">Taille :</label><br>
-        <input type="number" id="size" name="size" value="<?php if (isset($size)) echo $size; ?>" min="0" step="0.1" />
+        <input type="number" id="size" name="size" value="<?php if (isset($size)) echo htmlspecialchars($size); ?>" min="0" step="0.1" />

         <br>

         <label for="notes">Notes :</label><br>
-        <textarea id="notes" name="notes" rows="4" cols="50"><?php if (isset($notes)) echo $notes; ?></textarea>
+        <textarea id="notes" name="notes" rows="4" cols="50"><?php if (isset($notes)) echo htmlspecialchars($notes); ?></textarea>

         <br>
         <br>

         <button type="submit">CrÃ©er</button><br>
         <button type="reset">RÃ©initialiser</button>
     </form>
 </body>

 </html>
```

</details>

La page `create.php` est maintenant sÃ©curisÃ©e contre les attaques XSS.

### Ã‰tape 4 : tester l'application

Une fois que vous avez corrigÃ© toutes les vulnÃ©rabilitÃ©s, testez l'application
pour vous assurer que tout fonctionne correctement :

- Utilisez toutes les pages de l'application (`index.php`, `create.php` et
  `view.php`) et vÃ©rifiez que les donnÃ©es sont correctement Ã©chappÃ©es.

Toutes donnÃ©es affichÃ©es sur la page provenant de saisies utilisateur doivent
Ãªtre Ã©chappÃ©es pour Ã©viter les attaques XSS.

## Ajout de la possibilitÃ© de mettre Ã  jour un animal

Afin de finaliser les fonctionnalitÃ©s de notre application de gestion d'animaux
de compagnie, il ne reste qu'Ã  ajouter la possibilitÃ© de mettre Ã  jour un animal
de compagnie.

### Ajout du fichier `edit.php`

Pour ajouter la possibilitÃ© de mettre Ã  jour un animal de compagnie, vous devez
crÃ©er un nouveau fichier `edit.php` qui contiendra le formulaire de mise Ã  jour
de l'animal.

Votre structure de projet devrait ressembler Ã  ceci :

```text
progserv1/
â”œâ”€â”€ exercices/
â”‚   â””â”€â”€ index.php
â”œâ”€â”€ mini-projet/
â”‚   â”œâ”€â”€ create.php
â”‚   â”œâ”€â”€ database.php
â”‚   â”œâ”€â”€ edit.php
â”‚   â”œâ”€â”€ functions.php
â”‚   â”œâ”€â”€ index.php
â”‚   â””â”€â”€ view.php
â”œâ”€â”€ index.php
â””â”€â”€ phpinfo.php
```

ComplÃ©tez le fichier `edit.php` avec le code suivant :

```php
<?php
require 'functions.php';

// On vÃ©rifie si l'ID de l'animal est passÃ© dans l'URL
if (isset($_GET["id"])) {
    // On rÃ©cupÃ¨re l'ID de l'animal de la superglobale `$_GET`
    $petId = $_GET["id"];

    // On rÃ©cupÃ¨re l'animal correspondant Ã  l'ID
    $pet = getPet($petId);

    // Si l'animal n'existe pas, on redirige vers la page d'accueil
    if (!$pet) {
        header("Location: index.php");
        exit();
    } else {
        // Sinon, on initialise les variables
        $id = $pet['id'];
        $name = $pet['name'];
        $species = $pet['species'];
        $nickname = $pet['nickname'];
        $sex = $pet['sex'];
        $age = $pet['age'];
        $color = $pet['color'];
        $personalities = $pet['personalities'];
        $size = $pet['size'];
        $notes = $pet['notes'];
    }
} else if ($_SERVER["REQUEST_METHOD"] == "POST") {
    // GÃ¨re la soumission du formulaire

    // RÃ©cupÃ©ration des donnÃ©es du formulaire
    $id = $_POST["id"];
    $name = $_POST["name"];
    $species = $_POST["species"];
    $nickname = $_POST["nickname"];
    $sex = $_POST["sex"];
    $age = $_POST["age"];
    $color = $_POST["color"];
    $personalities = isset($_POST["personalities"]) ? $_POST["personalities"] : [];
    $size = $_POST["size"];
    $notes = $_POST["notes"];

    // Par dÃ©faut, il n'y a pas d'erreurs
    $errors = [];

    // Validation des donnÃ©es
    if (empty($name)) {
        // On ajoute un message d'erreur au tableau
        array_push($errors, "Le nom est obligatoire.");
    }

    if (strlen($name) < 2) {
        // On ajoute un message d'erreur au tableau
        array_push($errors, "Le nom doit contenir au moins 2 caractÃ¨res.");
    }

    if (empty($species)) {
        // On ajoute un message d'erreur au tableau
        array_push($errors, "L'espÃ¨ce est obligatoire.");
    }

    if (empty($sex)) {
        // On ajoute un message d'erreur au tableau
        array_push($errors, "Le sexe est obligatoire.");
    }

    if (empty($age)) {
        // On ajoute un message d'erreur au tableau
        array_push($errors, "L'Ã¢ge est obligatoire.");
    }

    if (!is_numeric($age) || $age < 0) {
        // On ajoute un message d'erreur au tableau
        array_push($errors, "L'Ã¢ge doit Ãªtre un nombre entier positif.");
    }

    if (!empty($size) && (!is_numeric($size) || $size < 0)) {
        // On ajoute un message d'erreur au tableau
        array_push($errors, "La taille doit Ãªtre un nombre entier positif.");
    }

    // Si le formulaire est valide, on met Ã  jour l'animal
    if (empty($errors)) {
        // On met Ã  jour l'animal dans la base de donnÃ©es
        $success = updatePet(
            $id,
            $name,
            $species,
            $nickname,
            $sex,
            $age,
            $color,
            $personalities,
            $size,
            $notes
        );

        // On vÃ©rifie si la mise Ã  jour a rÃ©ussi
        if ($success) {
            // On redirige vers la page de l'animal modifiÃ©
            header("Location: view.php?id=$id");
            exit();
        } else {
            // Si la mise Ã  jour a Ã©chouÃ©, on affiche un message d'erreur
            $errors[] = "La mise Ã  jour a Ã©chouÃ©.";
        }
    }
} else {
    // Si l'ID n'est pas passÃ© dans l'URL, on redirige vers la page d'accueil
    header("Location: index.php");
    exit();
}
?>

<!DOCTYPE html>
<html lang="fr">

<head>
    <title>Modifie un animal de compagnie | Gestionnaire d'animaux de compagnie</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
            color: #333;
        }

        h1 {
            text-align: center;
            color: #444;
        }

        p {
            text-align: center;
        }

        form {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        label {
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="number"],
        input[type="color"],
        textarea,
        select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        input[type="radio"],
        input[type="checkbox"] {
            margin-right: 5px;
        }

        input[type="radio"]+label,
        input[type="checkbox"]+label {
            display: inline-block;
            margin-right: 15px;
        }

        fieldset div {
            display: inline-block;
            margin-right: 10px;
        }

        fieldset {
            margin-top: 5px;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        legend {
            font-weight: bold;
        }

        button {
            display: block;
            width: 100%;
            padding: 10px;
            background-color: #5cb85c;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }

        button:hover {
            background-color: #4cae4c;
        }

        a {
            color: #5cb85c;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <h1>Modifie un animal de compagnie</h1>
    <p><a href="index.php">Retour Ã  l'accueil</a></p>
    <p>Utilise cette page pour modifier un animal de compagnie.</p>

    <?php if ($_SERVER["REQUEST_METHOD"] == "POST") { ?>
        <?php if (empty($errors)) { ?>
            <p style="color: green;">Le formulaire a Ã©tÃ© soumis avec succÃ¨s !</p>
        <?php } else { ?>
            <p style="color: red;">Le formulaire contient des erreurs :</p>
            <ul>
                <?php foreach ($errors as $error) { ?>
                    <li><?= $error; ?></li>
                <?php } ?>
            </ul>
        <?php } ?>
    <?php } ?>

    <form action="edit.php" method="POST">
        <input type="hidden" name="id" value="<?= htmlentities($pet["id"]) ?>" />

        <label for="name">Nom :</label><br>
        <input type="text" id="name" name="name" value="<?= isset($name) ? htmlspecialchars($name) : "" ?>" required minlength="2">

        <br>

        <label for="species">EspÃ¨ce :</label><br>
        <select id="species" name="species" required>
            <option value="dog" <?= isset($species) && $species == "dog" ? "selected" : "" ?>>Chien</option>
            <option value="cat" <?= isset($species) && $species == "cat" ? "selected" : "" ?>>Chat</option>
            <option value="lizard" <?= isset($species) && $species == "lizard" ? "selected" : "" ?>>LÃ©zard</option>
            <option value="snake" <?= isset($species) && $species == "snake" ? "selected" : "" ?>>Serpent</option>
            <option value="bird" <?= isset($species) && $species == "bird" ? "selected" : "" ?>>Oiseau</option>
            <option value="rabbit" <?= isset($species) && $species == "rabbit" ? "selected" : "" ?>>Lapin</option>
            <option value="other" <?= isset($species) && $species == "other" ? "selected" : "" ?>>Autre</option>
        </select>

        <br>

        <label for="nickname">Surnom :</label><br>
        <input type="text" id="nickname" name="nickname" value="<?= isset($nickname) ? htmlspecialchars($nickname) : "" ?>" />

        <fieldset>
            <legend>Sexe :</legend>

            <input type="radio" id="male" name="sex" value="male" <?= isset($sex) && $sex == "male" ? "checked" : "" ?> required />
            <label for="male">MÃ¢le</label><br>

            <input type="radio" id="female" name="sex" value="female" <?= isset($sex) && $sex == "female" ? "checked" : ""; ?> required />
            <label for="female">Femelle</label>
        </fieldset>

        <br>

        <label for="age">Ã‚ge :</label><br>
        <input type="number" id="age" name="age" value="<?= isset($age) ? htmlspecialchars($age) : "" ?>" required min="0" />

        <br>

        <label for="color">Couleur :</label><br>
        <input type="color" id="color" name="color" value="<?= isset($color) ? htmlspecialchars($color) : "" ?>" />

        <fieldset>
            <legend>PersonnalitÃ© :</legend>

            <div>
                <input type="checkbox" id="gentil" name="personalities[]" value="gentil" <?= !empty($personalities) && in_array("gentil", $personalities) ? "checked" : "" ?> />
                <label for="gentil">Gentil</label>
            </div>

            <div>
                <input type="checkbox" id="playful" name="personalities[]" value="playful" <?= !empty($personalities) && in_array("playful", $personalities) ? "checked" : "" ?> />
                <label for="playful">Joueur</label>
            </div>

            <div>
                <input type="checkbox" id="curious" name="personalities[]" value="curious" <?= !empty($personalities) && in_array("curious", $personalities) ? "checked" : "" ?> />
                <label for="curious">Curieux</label>
            </div>

            <div>
                <input type="checkbox" id="lazy" name="personalities[]" value="lazy" <?= !empty($personalities) && in_array("lazy", $personalities) ? "checked" : "" ?> />
                <label for="lazy">Paresseux</label>
            </div>

            <div>
                <input type="checkbox" id="scared" name="personalities[]" value="scared" <?= !empty($personalities) && in_array("scared", $personalities) ? "checked" : "" ?> />
                <label for="scared">Peureux</label>
            </div>

            <div>
                <input type="checkbox" id="aggressive" name="personalities[]" value="aggressive" <?= !empty($personalities) && in_array("aggressive", $personalities) ? "checked" : "" ?> />
                <label for="aggressive">Agressif</label>
            </div>
        </fieldset>

        <br>

        <label for="size">Taille :</label><br>
        <input type="number" id="size" name="size" value="<?= isset($size) ? htmlspecialchars($size) : "" ?>" min="0" step="0.1" />

        <br>

        <label for="notes">Notes :</label><br>
        <textarea id="notes" name="notes" rows="4" cols="50"><?= isset($notes) ? htmlspecialchars($notes) : "" ?></textarea>

        <br>
        <br>

        <a href="delete.php?id=<?= htmlspecialchars($pet["id"]) ?>">
            <button type="button">Supprimer</button>
        </a><br>
        <button type="submit">Mettre Ã  jour</button><br>
        <button type="reset">RÃ©initialiser</button>
    </form>
</body>

</html>

</head>
```

Prenez le temps de lire le code et de comprendre son fonctionnement.

Vous remarquerez peut-Ãªtre que le code est trÃ¨s similaire Ã  celui des fichiers
`create.php` et `view.php`. Cela est normal car le formulaire de mise Ã  jour est
une fusion de ces deux fonctionnalitÃ©s.

Prenons le temps de passer en revue les diffÃ©rentes parties du code. Le contenu
de certains blocs de code sont volontairement laissÃ©s vides pour se concentrer
sur le fonctionnement global de la page.

```php
if (isset($_GET["id"])) {
    // 1. On vÃ©rifie si l'ID de l'animal est passÃ© dans l'URL
    // ...
} else if ($_SERVER["REQUEST_METHOD"] == "POST") {
    // 2. On gÃ¨re la soumission du formulaire
    // ...
} else {
    // 3. Si l'ID n'est pas passÃ© dans l'URL, on redirige vers la page d'accueil
    // ...
}

// 4. Affichage du formulaire
// ...
```

1. Dans cette premiÃ¨re partie, nous vÃ©rifions si l'ID de l'animal est passÃ© dans
   l'URL. Si c'est le cas, nous rÃ©cupÃ©rons l'animal correspondant Ã  cet ID.
2. Si nous sommes dans le cas oÃ¹ l'utilisateur a soumis le formulaire, nous
   rÃ©cupÃ©rons les donnÃ©es du formulaire et nous les validons. Si le formulaire
   est valide, nous mettons Ã  jour l'animal dans la base de donnÃ©es.
3. Si l'ID n'est pas passÃ© dans l'URL et que nous ne sommes pas dans le cas oÃ¹
   l'utilisateur a soumis le formulaire, nous redirigeons vers la page
   d'accueil.
4. Enfin, nous affichons le formulaire de mise Ã  jour de l'animal avec les
   donnÃ©es prÃ©-remplies et les erreurs Ã©ventuelles.

Concentrons-nous sur la partie de code qui rÃ©cupÃ¨re l'animal Ã  partir de son ID
(point 1 et point 3) :

```php
if (isset($_GET["id"])) {
    // On rÃ©cupÃ¨re l'ID de l'animal de la superglobale `$_GET`
    $petId = $_GET["id"];

    // On rÃ©cupÃ¨re l'animal correspondant Ã  l'ID
    $pet = getPet($petId);

    // Si l'animal n'existe pas, on redirige vers la page d'accueil
    if (!$pet) {
        header("Location: index.php");
        exit();
    } else {
        // Sinon, on initialise les variables
        $id = $pet['id'];
        $name = $pet['name'];
        $species = $pet['species'];
        $nickname = $pet['nickname'];
        $sex = $pet['sex'];
        $age = $pet['age'];
        $color = $pet['color'];
        $personalities = $pet['personalities'];
        $size = $pet['size'];
        $notes = $pet['notes'];
    }
} else if ($_SERVER["REQUEST_METHOD"] == "POST") {
    // On gÃ¨re la soumission du formulaire
    // ...
} else {
    // Si l'ID n'est pas passÃ© dans l'URL, on redirige vers la page d'accueil
    header("Location: index.php");
    exit();
}
```

Dans cette partie, trÃ¨s semblable Ã  la page `view.php`, nous vÃ©rifions si l'ID
de l'animal est passÃ© dans l'URL. Nous utilisons la fonction `getPet()` pour
rÃ©cupÃ©rer l'animal correspondant Ã  l'ID. Si l'animal n'existe pas, nous
redirigeons vers la page d'accueil.

Sinon, nous initialisons les variables avec les donnÃ©es de l'animal.

Cette derniÃ¨re partie est importante car elle nous permet de prÃ©-remplir le
formulaire avec les donnÃ©es de l'animal Ã  mettre Ã  jour et de garder les mÃªmes
noms de variables, autant lors de la construction du formulaire que lors de la
soumission du formulaire.

Dans le bloc du code `else`, nous redirigeons vers la page d'accueil si l'ID
n'est pas passÃ© dans l'URL. Cela permet d'Ã©viter d'afficher le formulaire de
mise Ã  jour sans avoir d'animal Ã  mettre Ã  jour.

Concentrons-nous maintenant sur la partie d'affichage du formulaire de mise Ã 
jour de l'animal (point 4)

```php
    <form action="edit.php" method="POST">
        <input type="hidden" name="id" value="<?= htmlentities($pet["id"]) ?>" />

        <label for="name">Nom :</label><br>
        <input type="text" id="name" name="name" value="<?= isset($name) ? htmlspecialchars($name) : "" ?>" required minlength="2">

        <br>

        <label for="species">EspÃ¨ce :</label><br>
        <select id="species" name="species" required>
            <option value="dog" <?= isset($species) && $species == "dog" ? "selected" : "" ?>>Chien</option>
            <option value="cat" <?= isset($species) && $species == "cat" ? "selected" : "" ?>>Chat</option>
            <option value="lizard" <?= isset($species) && $species == "lizard" ? "selected" : "" ?>>LÃ©zard</option>
            <option value="snake" <?= isset($species) && $species == "snake" ? "selected" : "" ?>>Serpent</option>
            <option value="bird" <?= isset($species) && $species == "bird" ? "selected" : "" ?>>Oiseau</option>
            <option value="rabbit" <?= isset($species) && $species == "rabbit" ? "selected" : "" ?>>Lapin</option>
            <option value="other" <?= isset($species) && $species == "other" ? "selected" : "" ?>>Autre</option>
        </select>

        <br>

        <label for="nickname">Surnom :</label><br>
        <input type="text" id="nickname" name="nickname" value="<?= isset($nickname) ? htmlspecialchars($nickname) : "" ?>" />

        <fieldset>
            <legend>Sexe :</legend>

            <input type="radio" id="male" name="sex" value="male" <?= isset($sex) && $sex == "male" ? "checked" : "" ?> required />
            <label for="male">MÃ¢le</label><br>

            <input type="radio" id="female" name="sex" value="female" <?= isset($sex) && $sex == "female" ? "checked" : ""; ?> required />
            <label for="female">Femelle</label>
        </fieldset>

        <br>

        <label for="age">Ã‚ge :</label><br>
        <input type="number" id="age" name="age" value="<?= isset($age) ? htmlspecialchars($age) : "" ?>" required min="0" />

        <br>

        <label for="color">Couleur :</label><br>
        <input type="color" id="color" name="color" value="<?= isset($color) ? htmlspecialchars($color) : "" ?>" />

        <fieldset>
            <legend>PersonnalitÃ© :</legend>

            <div>
                <input type="checkbox" id="gentil" name="personalities[]" value="gentil" <?= !empty($personalities) && in_array("gentil", $personalities) ? "checked" : "" ?> />
                <label for="gentil">Gentil</label>
            </div>

            <div>
                <input type="checkbox" id="playful" name="personalities[]" value="playful" <?= !empty($personalities) && in_array("playful", $personalities) ? "checked" : "" ?> />
                <label for="playful">Joueur</label>
            </div>

            <div>
                <input type="checkbox" id="curious" name="personalities[]" value="curious" <?= !empty($personalities) && in_array("curious", $personalities) ? "checked" : "" ?> />
                <label for="curious">Curieux</label>
            </div>

            <div>
                <input type="checkbox" id="lazy" name="personalities[]" value="lazy" <?= !empty($personalities) && in_array("lazy", $personalities) ? "checked" : "" ?> />
                <label for="lazy">Paresseux</label>
            </div>

            <div>
                <input type="checkbox" id="scared" name="personalities[]" value="scared" <?= !empty($personalities) && in_array("scared", $personalities) ? "checked" : "" ?> />
                <label for="scared">Peureux</label>
            </div>

            <div>
                <input type="checkbox" id="aggressive" name="personalities[]" value="aggressive" <?= !empty($personalities) && in_array("aggressive", $personalities) ? "checked" : "" ?> />
                <label for="aggressive">Agressif</label>
            </div>
        </fieldset>

        <br>

        <label for="size">Taille :</label><br>
        <input type="number" id="size" name="size" value="<?= isset($size) ? htmlspecialchars($size) : "" ?>" min="0" step="0.1" />

        <br>

        <label for="notes">Notes :</label><br>
        <textarea id="notes" name="notes" rows="4" cols="50"><?= isset($notes) ? htmlspecialchars($notes) : "" ?></textarea>

        <br>
        <br>

        <a href="delete.php?id=<?= htmlspecialchars($pet["id"]) ?>">
            <button type="button">Supprimer</button>
        </a><br>
        <button type="submit">Mettre Ã  jour</button><br>
        <button type="reset">RÃ©initialiser</button>
    </form>
```

Dans cette partie, trÃ¨s similaire Ã  la page `create.php`, nous affichons le
formulaire de mise Ã  jour de l'animal avec les donnÃ©es prÃ©-remplies. Nous
utilisons la fonction `htmlspecialchars()` pour Ã©chapper les donnÃ©es de l'animal
afin d'Ã©viter les attaques XSS.

Lorsque l'utilisateur accÃ¨de Ã  la page `edit.php`, nous affichons le formulaire
de mise Ã  jour de l'animal avec les donnÃ©es prÃ©-remplies issues des variables
initialisÃ©es prÃ©cÃ©demment.

Un point important Ã  noter est que nous avons ajoutÃ© un champ cachÃ©
[`<input type="hidden" />`](https://developer.mozilla.org/en-US/docs/Web/HTML/Reference/Elements/input/hidden)
qui contient l'ID de l'animal Ã  mettre Ã  jour.

Un champ cachÃ© est un champ de formulaire qui n'est pas visible pour
l'utilisateur, mais qui est envoyÃ© avec le formulaire lors de la soumission. Il
est utilisÃ© pour stocker des informations que l'utilisateur ne doit pas
modifier, mais qui sont nÃ©cessaires pour le traitement du formulaire.

Dans ce cas, nous utilisons le champ cachÃ© pour stocker l'ID de l'animal Ã 
mettre Ã  jour. Lorsque le formulaire est soumis, l'ID de l'animal est envoyÃ©
avec les autres donnÃ©es du formulaire. Cela nous permet de savoir quel animal
mettre Ã  jour lorsque le formulaire est soumis.

Lorsque l'utilisateur soumet le formulaire, nous transmettons toutes les
informations nÃ©cessaires Ã  la page `edit.php` (la page elle-mÃªme) pour mettre Ã 
jour l'animal dans la base de donnÃ©es, ce qui nous amÃ¨ne Ã  la partie suivante.

Concentrons-nous sur la partie de code qui gÃ¨re la soumission du formulaire et
la mise Ã  jour de l'animal (point 2) :

```php
if (isset($_GET["id"])) {
    // On vÃ©rifie si l'ID de l'animal est passÃ© dans l'URL
    // ...
} else if ($_SERVER["REQUEST_METHOD"] == "POST") {
    // GÃ¨re la soumission du formulaire

    // RÃ©cupÃ©ration des donnÃ©es du formulaire
    $id = $_POST["id"];
    $name = $_POST["name"];
    $species = $_POST["species"];
    $nickname = $_POST["nickname"];
    $sex = $_POST["sex"];
    $age = $_POST["age"];
    $color = $_POST["color"];
    $personalities = isset($_POST["personalities"]) ? $_POST["personalities"] : [];
    $size = $_POST["size"];
    $notes = $_POST["notes"];

    // Par dÃ©faut, il n'y a pas d'erreurs
    $errors = [];

    // Validation des donnÃ©es
    if (empty($name)) {
        // On ajoute un message d'erreur au tableau
        array_push($errors, "Le nom est obligatoire.");
    }

    if (strlen($name) < 2) {
        // On ajoute un message d'erreur au tableau
        array_push($errors, "Le nom doit contenir au moins 2 caractÃ¨res.");
    }

    if (empty($species)) {
        // On ajoute un message d'erreur au tableau
        array_push($errors, "L'espÃ¨ce est obligatoire.");
    }

    if (empty($sex)) {
        // On ajoute un message d'erreur au tableau
        array_push($errors, "Le sexe est obligatoire.");
    }

    if (empty($age)) {
        // On ajoute un message d'erreur au tableau
        array_push($errors, "L'Ã¢ge est obligatoire.");
    }

    if (!is_numeric($age) || $age < 0) {
        // On ajoute un message d'erreur au tableau
        array_push($errors, "L'Ã¢ge doit Ãªtre un nombre entier positif.");
    }

    if (!empty($size) && (!is_numeric($size) || $size < 0)) {
        // On ajoute un message d'erreur au tableau
        array_push($errors, "La taille doit Ãªtre un nombre entier positif.");
    }

    // Si le formulaire est valide, on met Ã  jour l'animal
    if (empty($errors)) {
        // On met Ã  jour l'animal dans la base de donnÃ©es
        $success = updatePet(
            $id,
            $name,
            $species,
            $nickname,
            $sex,
            $age,
            $color,
            $personalities,
            $size,
            $notes
        );

        // On vÃ©rifie si la mise Ã  jour a rÃ©ussi
        if ($success) {
            // On redirige vers la page de l'animal modifiÃ©
            header("Location: view.php?id=$id");
            exit();
        } else {
            // Si la mise Ã  jour a Ã©chouÃ©, on affiche un message d'erreur
            $errors[] = "La mise Ã  jour a Ã©chouÃ©.";
        }
    }
} else {
    // Si l'ID n'est pas passÃ© dans l'URL, on redirige vers la page d'accueil
    // ...
}

// Affichage du formulaire
// ...
```

Dans cette partie, trÃ¨s similaire au fichier `create.php`, nous rÃ©cupÃ©rons les
donnÃ©es du formulaire et nous les validons. Si le formulaire est valide, nous
appelons la fonction `updatePet()` pour mettre Ã  jour l'animal dans la base de
donnÃ©es.

Vous remarquerez peut-Ãªtre que nous rÃ©cupÃ©rons l'ID de l'animal Ã  partir du
champ cachÃ© du formulaire. Cela nous permet de savoir quel animal mettre Ã  jour
lorsque le formulaire est soumis.

Nous vÃ©rifions Ã©galement si la mise Ã  jour a rÃ©ussi. Si c'est le cas, nous
redirigeons vers la page de l'animal modifiÃ©. Sinon, nous affichons un message
d'erreur.

Si une erreur survient lors de la mise Ã  jour, nous affichons les diffÃ©rents
messages d'erreur en utilisant les mÃªmes noms de variables que ceux initialisÃ©s
lors de la rÃ©cupÃ©ration des donnÃ©es de l'animal dans la base de donnÃ©es et
prÃ©-remplissons le formulaire avec les donnÃ©es de l'animal, permettant ainsi de
corriger les erreurs.

### Mise Ã  jour de la fonction `updatePet()`

Dans le fichier `functions.php`, vous devez mettre Ã  jour la fonction
`updatePet()` pour qu'elle prenne en compte les nouvelles donnÃ©es passÃ©es dans
le formulaire de mise Ã  jour :

```php

function updatePet(
    $id,
    $name,
    $species,
    $nickname,
    $sex,
    $age,
    $color,
    $personalities,
    $size,
    $notes
) {
    // On utilise le mot-clÃ© `global` pour accÃ©der Ã  la variable `$pdo`.
    // MÃªme si c'est une mauvaise pratique, c'est nÃ©cessaire ici.
    global $pdo;

    // On transforme le tableau `$personalities` en chaÃ®ne de caractÃ¨res avec `implode`
    $personalitiesAsString = implode(',', $personalities);

    // On dÃ©finit la requÃªte SQL pour mettre Ã  jour un animal
    $sql = "UPDATE pets SET
        name = :name,
        species = :species,
        nickname = :nickname,
        sex = :sex,
        age = :age,
        color = :color,
        personalities = :personalities,
        size = :size,
        notes = :notes
    WHERE id = :id";

    // On prÃ©pare la requÃªte SQL
    $stmt = $pdo->prepare($sql);

    // On lie les paramÃ¨tres
    $stmt->bindValue(':id', $id);
    $stmt->bindValue(':name', $name);
    $stmt->bindValue(':species', $species);
    $stmt->bindValue(':nickname', $nickname);
    $stmt->bindValue(':sex', $sex);
    $stmt->bindValue(':age', $age);
    $stmt->bindValue(':color', $color);
    $stmt->bindValue(':personalities', $personalitiesAsString);
    $stmt->bindValue(':size', $size);
    $stmt->bindValue(':notes', $notes);

    // On exÃ©cute la requÃªte SQL pour mettre Ã  jour un animal
    return $stmt->execute();
}
```

Cette fonction est trÃ¨s similaire Ã  la fonction `addPet()`, mais elle utilise
une requÃªte SQL `UPDATE` au lieu d'une requÃªte `INSERT`. Elle prend Ã©galement en
compte l'ID de l'animal Ã  mettre Ã  jour.

En utilisant toutes les bonnes pratiques de sÃ©curitÃ©, nous avons utilisÃ© des
requÃªtes prÃ©parÃ©es pour Ã©viter les injections SQL.

La mÃ©thode `execute()` renvoie `true` si la mise Ã  jour a rÃ©ussi, sinon elle
renvoie `false`.

### Mise Ã  jour du fichier `view.php`

Afin de permettre la mise Ã  jour d'un animal, vous devez mettre Ã  jour le
fichier `view.php` pour y ajouter un bouton vers la page d'Ã©dition de celui-ci :

```php
        <a href="delete.php?id=<?= htmlspecialchars($pet["id"]) ?>">
            <button type="button">Supprimer</button>
        </a><br>
        <a href="edit.php?id=<?= htmlspecialchars($pet["id"]) ?>">
            <button type="button">Mettre Ã  jour</button>
        </a>
```

### Mise Ã  jour du fichier `index.php`

De la mÃªme maniÃ¨re que le fichier `view.php`, vous devez mettre Ã  jour le
fichier `index.php` pour ajouter un bouton vers la page de mise Ã  jour de
l'animal :

```php
                    <td>
                        <a href="delete.php?id=<?= htmlspecialchars($pet['id']) ?>"><button>Supprimer</button></a>
                        <a href="edit.php?id=<?= htmlspecialchars($pet['id']) ?>"><button>Ã‰diter</button></a>
                        <a href="view.php?id=<?= htmlspecialchars($pet['id']) ?>"><button>Visualiser</button></a>
                    </td>
```

### Tests de l'application

Une fois que vous avez ajoutÃ© la fonctionnalitÃ© de mise Ã  jour, testez
l'application pour vous assurer que tout fonctionne correctement :

- CrÃ©ez un nouvel animal de compagnie.
- Visualisez la liste des animaux de compagnie.
- Visualisez l'animal de compagnie que vous venez de crÃ©er.
- Mettez Ã  jour l'animal de compagnie que vous venez de crÃ©er.
- VÃ©rifiez que les donnÃ©es sont correctement mises Ã  jour.
- Supprimez l'animal de compagnie que vous venez de crÃ©er.

## Solution

Vous pouvez trouver la solution du mini-projet PHP Ã  l'adresse suivante :
[`solution`](./solution/).

## Conclusion

Vous avez maintenant une application de gestion d'animaux de compagnie
fonctionnelle avec la possibilitÃ© de crÃ©er, visualiser, mettre Ã  jour et
supprimer des animaux de compagnie ! Bravo ! Vous pouvez Ãªtre fier.e de vous !

Dans le prochain cours, nous verrons comment amÃ©liorer la structure de notre
application en utilisant des principes de programmation orientÃ©e objet (POO)
pour rendre notre code plus modulaire, rÃ©utilisable et plus facile Ã  comprendre
et maintenir.

## Aller plus loin

_Ceci est une section optionnelle pour les personnes qui souhaitent aller plus
loin. Vous pouvez la sauter si vous n'avez pas de temps._

- Ajoutez la possibilitÃ© de trier les animaux par age dans la liste des animaux.
  - Vous pouvez utiliser un paramÃ¨tre dans l'URL (tel que `?ageSort=asc` ou
    `?ageSort=desc`) pour dÃ©terminer l'ordre de tri.
  - Vous pouvez utiliser la fonction
    [`usort()`](https://www.php.net/manual/fr/function.usort.php) pour trier un
    tableau d'animaux.
- Ajoutez la possibilitÃ© de filtrer les animaux par espÃ¨ce dans la liste des
  animaux.
  - Vous pouvez utiliser un paramÃ¨tre dans l'URL (tel que `?species=dog`) pour
    filtrer les animaux par espÃ¨ce.
  - Vous pouvez utiliser la fonction
    [`array_filter()`](https://www.php.net/manual/fr/function.array-filter.php)
    pour filtrer un tableau d'animaux.
